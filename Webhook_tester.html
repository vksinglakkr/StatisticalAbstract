<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Webhook Tester</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-800 mb-8">üîß Webhook Tester</h1>
    
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">Test Your Webhook</h2>
      
      <div class="mb-4">
        <label class="block text-gray-700 font-medium mb-2">Webhook URL</label>
        <input 
          type="text" 
          id="webhookUrl" 
          value="https://n8n-workflow-test.duckdns.org/webhook/stat-abstract"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />
      </div>
      
      <div class="mb-4">
        <label class="block text-gray-700 font-medium mb-2">Test Question</label>
        <input 
          type="text" 
          id="testQuestion" 
          value="What is the practical application of this?"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />
      </div>
      
      <button 
        onclick="testWebhook()" 
        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors"
      >
        üöÄ Test Webhook
      </button>
    </div>
    
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">üìä Test Results</h2>
      <div id="results" class="space-y-4"></div>
    </div>
    
    <div class="bg-white rounded-lg shadow-lg p-6">
      <h2 class="text-xl font-semibold mb-4">üìã Expected Response Format</h2>
      <pre class="bg-gray-50 p-4 rounded border border-gray-200 overflow-x-auto"><code>{
  "answer": "Your AI response text here...",
  "relatedQuestions": [
    "Related question 1?",
    "Related question 2?",
    "Related question 3?"
  ]
}</code></pre>
    </div>
  </div>

  <script>
    async function testWebhook() {
      const resultsDiv = document.getElementById('results');
      const webhookUrl = document.getElementById('webhookUrl').value;
      const question = document.getElementById('testQuestion').value;
      
      resultsDiv.innerHTML = '<div class="text-blue-600 font-medium">üîÑ Testing webhook...</div>';
      
      const payload = {
        question: question,
        language: "English",
        queryType: "STATISTICAL_CONCEPT_QUERY",
        mobNo: "test",
        deviceType: "Desktop",
        browser: "Chrome",
        timestamp: new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }),
        userAgent: navigator.userAgent
      };
      
      let html = '<div class="space-y-3">';
      
      // Show request
      html += `
        <div class="border-l-4 border-blue-500 pl-4">
          <h3 class="font-semibold text-gray-700">üì§ Request Sent</h3>
          <pre class="text-sm bg-gray-50 p-2 rounded mt-2 overflow-x-auto">${JSON.stringify(payload, null, 2)}</pre>
        </div>
      `;
      
      try {
        const startTime = Date.now();
        
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const responseTime = Date.now() - startTime;
        
        // Status check
        html += `
          <div class="border-l-4 ${response.ok ? 'border-green-500' : 'border-red-500'} pl-4">
            <h3 class="font-semibold text-gray-700">üìä Response Status</h3>
            <p class="mt-2"><span class="font-medium">Status Code:</span> ${response.status} ${response.statusText}</p>
            <p><span class="font-medium">Response Time:</span> ${responseTime}ms</p>
          </div>
        `;
        
        // Headers
        const headers = {};
        response.headers.forEach((value, key) => {
          headers[key] = value;
        });
        
        html += `
          <div class="border-l-4 border-purple-500 pl-4">
            <h3 class="font-semibold text-gray-700">üìã Response Headers</h3>
            <pre class="text-sm bg-gray-50 p-2 rounded mt-2 overflow-x-auto">${JSON.stringify(headers, null, 2)}</pre>
          </div>
        `;
        
        // Get raw response
        const responseText = await response.text();
        
        html += `
          <div class="border-l-4 border-yellow-500 pl-4">
            <h3 class="font-semibold text-gray-700">üìÑ Raw Response</h3>
            <pre class="text-sm bg-gray-50 p-2 rounded mt-2 overflow-x-auto">${responseText}</pre>
          </div>
        `;
        
        // Try to parse JSON
        try {
          const data = JSON.parse(responseText);
          
          html += `
            <div class="border-l-4 border-green-500 pl-4">
              <h3 class="font-semibold text-gray-700">‚úÖ Parsed JSON</h3>
              <pre class="text-sm bg-gray-50 p-2 rounded mt-2 overflow-x-auto">${JSON.stringify(data, null, 2)}</pre>
            </div>
          `;
          
          // Validate structure
          const validations = [];
          
          if (data.answer || data.error) {
            validations.push('‚úÖ Has "answer" or "error" field');
          } else {
            validations.push('‚ùå Missing "answer" or "error" field');
          }
          
          if (data.relatedQuestions) {
            if (Array.isArray(data.relatedQuestions)) {
              validations.push(`‚úÖ "relatedQuestions" is an array with ${data.relatedQuestions.length} items`);
            } else {
              validations.push('‚ö†Ô∏è "relatedQuestions" exists but is not an array');
            }
          } else {
            validations.push('‚ö†Ô∏è "relatedQuestions" field is missing (optional)');
          }
          
          html += `
            <div class="border-l-4 border-blue-500 pl-4">
              <h3 class="font-semibold text-gray-700">üîç Validation Results</h3>
              <ul class="mt-2 space-y-1">
                ${validations.map(v => `<li class="text-sm">${v}</li>`).join('')}
              </ul>
            </div>
          `;
          
        } catch (jsonError) {
          html += `
            <div class="border-l-4 border-red-500 pl-4">
              <h3 class="font-semibold text-gray-700">‚ùå JSON Parse Error</h3>
              <p class="text-red-600 mt-2">${jsonError.message}</p>
              <p class="text-sm text-gray-600 mt-2">The response is not valid JSON. This is the cause of your chatbot error!</p>
            </div>
          `;
        }
        
      } catch (error) {
        html += `
          <div class="border-l-4 border-red-500 pl-4">
            <h3 class="font-semibold text-gray-700">‚ùå Connection Error</h3>
            <p class="text-red-600 mt-2">${error.message}</p>
            <div class="mt-3 text-sm text-gray-600">
              <p><strong>Possible causes:</strong></p>
              <ul class="list-disc list-inside mt-1">
                <li>Webhook URL is incorrect</li>
                <li>Server is down or not responding</li>
                <li>CORS policy blocking the request</li>
                <li>Network connectivity issues</li>
              </ul>
            </div>
          </div>
        `;
      }
      
      html += '</div>';
      resultsDiv.innerHTML = html;
    }
  </script>
</body>
</html>
