<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Haryana DataVista
 – Statistical Abstract Chatbot</title>
<!-- VERSION: 4.1-STABLE - Last Modified Date Fixed, Music Toggle Safe Check Added -->
  <!-- VERSION: 4.0-CLEAN - File search removed, Last Modified fixed, FINAL VERSION -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Functions need to be defined before they're called in HTML
    function openPDFGuide() {
      window.open('STATS_SAHAYAK_Tutorial.html', '_blank');
    }
    
    function openTutorialVideos() {
      window.open('https://www.youtube.com/watch?v=YOUR_VIDEO_ID', '_blank');
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&family=Playfair+Display:wght@700;900&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
 <style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: radial-gradient(ellipse at top, #1e3a8a, #0f172a);
  font-family: 'Poppins', sans-serif;
  min-height: 100vh;
  position: relative;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-image: 
    radial-gradient(circle at 20% 50%, rgba(251, 191, 36, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(249, 115, 22, 0.1) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

.devanagari { font-family: 'Noto Sans Devanagari', sans-serif; }
.playfair { font-family: 'Playfair Display', serif; }
.container-main { position: relative; z-index: 1; }

.glass-card {
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.1) inset;
}

.gradient-text {
  background: linear-gradient(135deg, #ff6b35 0%, #f59e0b 50%, #ff6b35 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  background-size: 200% auto;
  animation: shimmer 3s linear infinite;
}

.mic-btn {
  transition: all 0.3s;
  -webkit-tap-highlight-color: transparent;
}

.mic-btn.recording {
  background: linear-gradient(135deg, #dc2626, #ef4444) !important;
  border-color: #dc2626 !important;
  animation: pulseRec 1.5s ease-in-out infinite;
}

@keyframes pulseRec {
  0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
  50% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
}

@keyframes shimmer { to { background-position: 200% center; } }

.header-glow { position: relative; }

.header-glow::before {
  content: '';
  position: absolute;
  top: -20px; left: 50%;
  transform: translateX(-50%);
  width: 200px; height: 200px;
  background: radial-gradient(circle, rgba(251, 191, 36, 0.3), transparent 70%);
  filter: blur(40px);
  pointer-events: none;
}

.tts-btn {
  padding: 8px 16px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  border: none;
  display: flex;
  align-items: center;
  gap: 6px;
}

.tts-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.tts-btn.speaking { animation: pulse 1.5s ease-in-out infinite; }

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.8; transform: scale(1.05); }
}

.lang-toggle {
  display: inline-flex;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 12px;
  padding: 4px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.lang-toggle button {
  padding: 8px 20px;
  border-radius: 10px;
  transition: all 0.3s;
  font-size: 14px;
  font-weight: 600;
  border: none;
  background: transparent;
  color: #64748b;
}

.lang-toggle button.active {
  background: linear-gradient(135deg, #1e40af, #3b82f6);
  color: white;
  box-shadow: 0 4px 12px rgba(30, 64, 175, 0.4);
  transform: scale(1.05);
}

.query-type-selector {
  background: linear-gradient(135deg, #fef3c7, #fed7aa);
  border: 3px solid #f59e0b;
  border-radius: 20px;
  padding: 20px 16px;
  margin-bottom: 24px;
  box-shadow: 0 8px 24px rgba(245, 158, 11, 0.3);
}

.radio-option {
  position: relative;
  display: flex;
  align-items: flex-start;
  padding: 14px 16px;
  background: white;
  border: 3px solid #e5e7eb;
  border-radius: 16px;
  cursor: pointer;
  transition: all 0.3s;
  margin-bottom: 12px;
  min-height: 80px;
}

.radio-option:last-child { margin-bottom: 0; }

.radio-option:hover {
  border-color: #f59e0b;
  transform: translateX(4px);
  box-shadow: 0 4px 16px rgba(245, 158, 11, 0.2);
}

.radio-option input[type="radio"] {
  width: 22px; height: 22px; min-width: 22px;
  margin-right: 12px; margin-top: 2px;
  cursor: pointer; accent-color: #f59e0b; flex-shrink: 0;
}

.radio-option.selected {
  border-color: #f59e0b;
  background: linear-gradient(135deg, #fffbeb, #fef3c7);
  box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
  transform: scale(1.02);
}

.radio-icon {
  font-size: 28px; min-width: 36px; margin-right: 8px;
  flex-shrink: 0; line-height: 1; margin-top: 2px;
}

.radio-label {
  display: flex; flex-direction: column;
  flex: 1; min-width: 0; gap: 2px;
}

.radio-label-title {
  font-size: 16px; font-weight: 700; color: #1f2937;
  line-height: 1.3; word-wrap: break-word;
  overflow-wrap: break-word; hyphens: auto;
}

/* Styles for links in AI response */
#modalAnswer a {
  color: #2563eb;
  text-decoration: underline;
  font-weight: 600;
  transition: all 0.2s;
  word-break: break-all;
}

#modalAnswer a:hover {
  color: #1d4ed8;
  background: rgba(37, 99, 235, 0.1);
  padding: 2px 4px;
  border-radius: 4px;
}

#modalAnswer a:visited {
  color: #7c3aed;
}

.radio-label-desc {
  font-size: 12px; color: #6b7280; line-height: 1.4;
  word-wrap: break-word; overflow-wrap: break-word;
}

.autocomplete-container { position: relative; width: 100%; }

.autocomplete-dropdown {
  position: absolute; top: 100%; left: 0; right: 0;
  background: white; border: 2px solid #f59e0b; border-top: none;
  border-radius: 0 0 16px 16px; max-height: 300px; overflow-y: auto;
  z-index: 1000; box-shadow: 0 8px 24px rgba(245, 158, 11, 0.3);
  margin-top: -8px;
}

.autocomplete-item {
  padding: 12px 16px; cursor: pointer;
  border-bottom: 1px solid #f3f4f6;
  transition: all 0.2s; font-size: 12px; line-height: 1.5;
}

.autocomplete-item:last-child { border-bottom: none; }

.autocomplete-item:hover {
  background: linear-gradient(135deg, #fffbeb, #fef3c7);
  font-weight: 600;
}

.autocomplete-item mark {
  background: #fef3c7; color: #ea580c; font-weight: 700;
  padding: 2px 4px; border-radius: 4px;
}

.autocomplete-no-results {
  padding: 16px; text-align: center;
  color: #6b7280; font-size: 14px;
}

.autocomplete-category {
  padding: 8px 16px; font-size: 11px; font-weight: 700;
  color: #f59e0b; background: #fffbeb;
  text-transform: uppercase; letter-spacing: 0.5px;
  border-bottom: 1px solid #fed7aa;
}

.slide-fade-enter { animation: slideFadeIn 0.5s ease-out; }

@keyframes slideFadeIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

#userInput::placeholder {
  font-size: 13px; color: #b5b5b5;
  font-weight: 400; opacity: 0.8;
}

#userInput {
  font-size: 17px !important; font-weight: 600 !important;
  color: #1f2937 !important; line-height: 1.5;
  vertical-align: bottom; width: 100% !important;
  box-sizing: border-box !important; display: block;
}

.icon { display: inline-block; width: 1em; height: 1em; vertical-align: -0.125em; }

.btn-primary {
  background: linear-gradient(135deg, #ff6b35, #f59e0b);
  color: white; font-weight: 700; padding: 18px 32px;
  border-radius: 16px; border: none; cursor: pointer;
  transition: all 0.3s; box-shadow: 0 8px 24px rgba(255, 107, 53, 0.4);
  position: relative; overflow: hidden;
}

.btn-primary::before {
  content: ''; position: absolute; top: 0; left: -100%;
  width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  transition: left 0.5s;
}

.btn-primary:hover::before { left: 100%; }
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(255, 107, 53, 0.5); }

.event-card {
  border-radius: 20px; padding: 20px;
  transition: all 0.3s; cursor: pointer;
  position: relative; overflow: hidden;
}

.event-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 16px 40px rgba(0,0,0,0.2); }

.quote-section {
  background: linear-gradient(135deg, #eff6ff, #dbeafe);
  border-left: 6px solid #3b82f6; border-radius: 24px;
  padding: 32px; box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);
  position: relative; overflow: hidden;
}

.quote-section::before {
  content: '"'; position: absolute; top: -20px; left: 20px;
  font-size: 120px; color: rgba(59, 130, 246, 0.1);
  font-family: Georgia, serif;
}

input, textarea, select { transition: all 0.3s; }
input:focus, textarea:focus, select:focus { transform: translateY(-2px); }

.modal-enter { animation: modalEnter 0.3s ease-out; }

@keyframes modalEnter {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}

.floating { animation: floating 3s ease-in-out infinite; }

@keyframes floating {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
}

.feedback-btn {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white; font-weight: 600; padding: 12px 24px;
  border-radius: 12px; border: none; cursor: pointer;
  transition: all 0.3s; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  display: inline-flex; align-items: center; gap: 8px; font-size: 14px;
}

.feedback-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
  background: linear-gradient(135deg, #059669, #047857);
}

.feedback-btn-small { padding: 8px 16px; font-size: 13px; }

#feedbackModal {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.85); z-index: 10000;
  display: none; align-items: center; justify-content: center; padding: 16px;
}

#feedbackModal.show { display: flex; }

.feedback-modal-content {
  background: white; border-radius: 24px; width: 100%;
  max-width: 900px; height: 90vh; max-height: 90vh;
  display: flex; flex-direction: column; overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.feedback-modal-header {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white; padding: 20px; display: flex;
  justify-content: space-between; align-items: center; flex-shrink: 0;
}

.feedback-modal-close {
  background: rgba(255, 255, 255, 0.2); border: none;
  color: white; width: 36px; height: 36px; border-radius: 50%;
  cursor: pointer; display: flex; align-items: center;
  justify-content: center; transition: all 0.3s;
}

.feedback-modal-close:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: rotate(90deg);
}

#feedbackIframe { width: 100%; height: 100%; border: none; background: white; }

.iframe-loader {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%); text-align: center; z-index: 1;
}

.spinner {
  border: 4px solid #f3f4f6; border-top: 4px solid #10b981;
  border-radius: 50%; width: 50px; height: 50px;
  animation: spin 1s linear infinite; margin: 0 auto 16px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.om-symbol {
  position: fixed; font-size: 200px; opacity: 0.05;
  color: rgba(251, 191, 36, 0.3); pointer-events: none;
  user-select: none; z-index: 0;
}

.om-top-right { top: -50px; right: -50px; }
.om-bottom-left { bottom: -50px; left: -50px; transform: rotate(180deg); }

.quiz-chatbot-btn, .live-telecast-btn {
  color: white; font-weight: 600; padding: 10px 18px;
  border-radius: 12px; border: none; cursor: pointer;
  transition: all 0.3s; display: inline-flex;
  align-items: center; gap: 8px; font-size: 14px;
  position: relative; overflow: hidden;
}

.quiz-chatbot-btn {
  background: linear-gradient(135deg, #8b5cf6, #6366f1);
  box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
}

.live-telecast-btn {
  background: linear-gradient(135deg, #dc2626, #ef4444);
  box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
}

.quiz-chatbot-btn::before, .live-telecast-btn::before {
  content: ''; position: absolute; top: 0; left: -100%;
  width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  transition: left 0.5s;
}

.quiz-chatbot-btn:hover::before, .live-telecast-btn:hover::before { left: 100%; }

.quiz-chatbot-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(139, 92, 246, 0.5);
  background: linear-gradient(135deg, #7c3aed, #4f46e5);
}

.live-telecast-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(220, 38, 38, 0.5);
  background: linear-gradient(135deg, #b91c1c, #dc2626);
}

.quiz-chatbot-btn svg, .live-telecast-btn svg {
  width: 20px; height: 20px;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
}

.live-telecast-btn .pulse-dot {
  width: 8px; height: 8px; background: white;
  border-radius: 50%; animation: pulse-live 1.5s ease-in-out infinite;
}

@keyframes pulse-live {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.2); }
}

#quizModal {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.9); z-index: 10001;
  display: none; align-items: center; justify-content: center; padding: 16px;
}

#quizModal.show { display: flex; }

.quiz-modal-content {
  background: white; border-radius: 24px; width: 100%;
  max-width: 1200px; height: 92vh; max-height: 92vh;
  display: flex; flex-direction: column; overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.quiz-modal-header {
  background: linear-gradient(135deg, #8b5cf6, #6366f1);
  color: white; padding: 20px; display: flex;
  justify-content: space-between; align-items: center; flex-shrink: 0;
}

.quiz-modal-close {
  background: rgba(255, 255, 255, 0.2); border: none;
  color: white; width: 36px; height: 36px; border-radius: 50%;
  cursor: pointer; display: flex; align-items: center;
  justify-content: center; transition: all 0.3s;
}

.quiz-modal-close:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: rotate(90deg);
}

#quizIframe { width: 100%; height: 100%; border: none; background: white; }

#questionSelect option {
  font-size: 13px !important;
  padding: 8px !important;
  line-height: 1.4;
}

#questionSelect optgroup {
  font-size: 14px !important;
  font-weight: 600;
  color: #1e40af;
}

/* ============================================================================
   MOBILE OPTIMIZATIONS - COMPACT LAYOUT (768px and below)
   ============================================================================ */

@media (max-width: 768px) {
  /* Header Compact */
  .header-glow { padding: 12px 16px 8px !important; }
  .header-glow h1 { font-size: 2.5rem !important; margin-bottom: 4px !important; }
  .header-glow > p { font-size: 11px !important; margin-bottom: 8px !important; }
  .header-glow > div:last-child { padding: 0 8px !important; }
  .header-glow > div:last-child > div { padding: 6px 12px !important; }
  .header-glow > div:last-child h2 { font-size: 10px !important; line-height: 1.3 !important; }
  .live-telecast-btn { padding: 6px 12px !important; font-size: 11px !important; }
  .live-telecast-btn svg { width: 16px !important; height: 16px !important; }

  /* Text Input Compact */
  #userInput {
    min-height: 80px !important; padding: 10px !important;
    padding-bottom: 40px !important; font-size: 15px !important;
    line-height: 1.4 !important;
  }
  #userInput::placeholder { font-size: 11px !important; }
  .mic-btn { padding: 8px !important; bottom: 6px !important; right: 6px !important; }
  .mic-btn svg { width: 20px !important; height: 20px !important; }
  .mb-8 { margin-bottom: 16px !important; }

  /* Event Cards Compact */
  .event-card { padding: 12px !important; border-radius: 12px !important; }
  .event-card svg { width: 28px !important; height: 28px !important; }
  .event-card .flex-1 p:first-child { font-size: 13px !important; line-height: 1.3 !important; }
  .event-card .flex-1 p:last-child { font-size: 10px !important; }
  .event-card a { padding: 6px 12px !important; font-size: 11px !important; margin-top: 6px !important; }
  .grid { gap: 12px !important; }

  /* Quote Section Compact */
  .quote-section { padding: 16px !important; margin-bottom: 16px !important; border-radius: 16px !important; }
  .quote-section > p:first-of-type { font-size: 14px !important; line-height: 1.4 !important; margin-bottom: 8px !important; }
  .quote-section > p:nth-of-type(2) { font-size: 11px !important; margin-bottom: 4px !important; margin-top: 4px !important; }
  .quote-section > p:last-child { font-size: 11px !important; margin-top: 8px !important; line-height: 1.3 !important; }
  .quote-section::before { font-size: 80px !important; top: -15px !important; }

  /* Button Compact */
  .btn-primary { padding: 12px 24px !important; font-size: 16px !important; margin-top: 16px !important; }
  .btn-primary svg { width: 20px !important; height: 20px !important; }
  .feedback-btn { padding: 8px 16px !important; font-size: 12px !important; }
  .feedback-btn svg { width: 16px !important; height: 16px !important; }

  /* Quick Help Compact */
  #quickQuestionsSection label { font-size: 16px !important; }
  .lang-toggle { padding: 3px !important; }
  .lang-toggle button { padding: 6px 14px !important; font-size: 12px !important; }
  #categorySelect, #questionSelect { padding: 10px 12px !important; font-size: 14px !important; }

  /* Overall Padding */
  .container-main { padding: 8px !important; max-width: 100vw; overflow-x: hidden; }
  .container-main > div:last-child { padding: 12px 16px !important; }
  .p-2 { padding: 8px !important; }
  body { padding: 8px !important; }
  * { max-width: 100%; }
}

@media (max-width: 640px) {
  .query-type-selector { padding: 16px 12px; }
  .radio-option { padding: 12px 12px; min-height: 85px; }
  .radio-option input[type="radio"] { width: 20px; height: 20px; min-width: 20px; margin-right: 10px; }
  .radio-icon { font-size: 24px; min-width: 32px; margin-right: 6px; }
  .radio-label-title { font-size: 16px; }
  .radio-label-desc { font-size: 11px; line-height: 1.35; }
  .autocomplete-dropdown { max-height: 250px; }
  .autocomplete-item { padding: 10px 12px; font-size: 11px; }
  #questionSelect option { font-size: 12px !important; padding: 6px !important; }
  #questionSelect optgroup { font-size: 13px !important; }
}

@media (max-width: 375px) {
  .header-glow h1 { font-size: 2rem !important; }
  .event-card .flex-1 p:first-child { font-size: 12px !important; }
  .quote-section > p:first-of-type { font-size: 13px !important; }
  #userInput { min-height: 70px !important; font-size: 14px !important; }
}

@media (max-width: 360px) {
  .radio-icon { font-size: 22px; min-width: 28px; }
  .radio-label-title { font-size: 14px; }
  .radio-label-desc { font-size: 10.5px; }
}   
   /* Fix icon alignment for last two cards (mobile) */
@media (max-width: 640px) {
  .event-card svg {
    width: 32px !important;
    height: 32px !important;
  }

  /* prevents icon from jumping upward */
  .event-card .flex {
    align-items: flex-start !important;
  }

  /* Optional: reduce card padding for tighter fit */
  .event-card {
    padding: 14px !important;
  }
}
/* Related Questions Styling */
#relatedQuestionsSection {
  animation: slideIn 0.4s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

#relatedQuestionsList button:hover {
  transform: translateX(4px);
  box-shadow: 0 4px 12px rgba(147, 51, 234, 0.15);
}
   

/* ============================================================================
   COMPARISON FEATURE STYLES - Smart Contextual Prompting
   ============================================================================ */

/* Comparison Prompt Container */
.comparison-prompt-container {
  background: linear-gradient(135deg, #f0f9ff, #dbeafe);
  border: 2px solid #0ea5e9;
  border-radius: 16px;
  padding: 24px;
  margin: 24px 0;
  box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
  animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.comparison-prompt-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 2px solid #bae6fd;
}

.comparison-prompt-icon {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, #0ea5e9, #0284c7);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
}

.comparison-prompt-text {
  flex: 1;
}

.comparison-prompt-title {
  font-size: 20px;
  font-weight: 700;
  color: #0c4a6e;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.comparison-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.comparison-prompt-desc {
  font-size: 14px;
  color: #64748b;
  line-height: 1.5;
}

.comparison-action-buttons {
  display: flex;
  gap: 12px;
  margin-top: 16px;
}

.enable-comparison-btn {
  flex: 1;
  background: linear-gradient(135deg, #0ea5e9, #0284c7);
  color: white;
  font-weight: 700;
  padding: 14px 24px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-size: 15px;
}

.enable-comparison-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(14, 165, 233, 0.4);
  background: linear-gradient(135deg, #0284c7, #0369a1);
}

.skip-comparison-btn {
  padding: 14px 24px;
  border-radius: 12px;
  border: 2px solid #cbd5e1;
  background: white;
  color: #64748b;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 14px;
}

.skip-comparison-btn:hover {
  border-color: #94a3b8;
  background: #f8fafc;
}

/* Year Selection Container */
.year-selection-container {
  background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
  border: 2px solid #0ea5e9;
  border-radius: 16px;
  padding: 20px;
  margin: 20px 0;
  box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
  display: none;
  animation: slideDown 0.4s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    max-height: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    max-height: 2000px;
    transform: translateY(0);
  }
}

.year-selection-container.visible {
  display: block;
}

.year-selection-title {
  font-size: 18px;
  font-weight: 700;
  color: #0c4a6e;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.year-checkboxes {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}

.year-checkbox-wrapper {
  display: flex;
  align-items: center;
  background: white;
  padding: 12px;
  border-radius: 12px;
  border: 2px solid #bae6fd;
  cursor: pointer;
  transition: all 0.3s;
}

.year-checkbox-wrapper:hover {
  border-color: #0ea5e9;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(14, 165, 233, 0.15);
}

.year-checkbox-wrapper input[type="checkbox"] {
  width: 20px;
  height: 20px;
  margin-right: 8px;
  cursor: pointer;
  accent-color: #0ea5e9;
}

.year-checkbox-wrapper label {
  font-weight: 600;
  color: #0c4a6e;
  cursor: pointer;
  user-select: none;
  flex: 1;
}

.year-checkbox-wrapper.selected {
  border-color: #0ea5e9;
  background: linear-gradient(135deg, #f0f9ff, #dbeafe);
  box-shadow: 0 2px 8px rgba(14, 165, 233, 0.2);
}

.year-selection-actions {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.quick-select-btn {
  background: white;
  border: 2px solid #0ea5e9;
  color: #0c4a6e;
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.quick-select-btn:hover {
  background: #f0f9ff;
  border-color: #0284c7;
  transform: translateY(-1px);
}

.generate-comparison-btn {
  background: linear-gradient(135deg, #0ea5e9, #0284c7);
  color: white;
  font-weight: 700;
  padding: 14px 28px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-size: 16px;
  width: 100%;
  justify-content: center;
}

.generate-comparison-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(14, 165, 233, 0.4);
  background: linear-gradient(135deg, #0284c7, #0369a1);
}

.generate-comparison-btn:disabled {
  background: linear-gradient(135deg, #94a3b8, #64748b);
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
  opacity: 0.6;
}

.year-selection-hint {
  font-size: 13px;
  color: #64748b;
  margin-top: 12px;
  font-style: italic;
  text-align: center;
}

/* Mobile Responsive */
@media (max-width: 640px) {
  .comparison-prompt-container {
    padding: 20px 16px;
  }
  
  .comparison-prompt-icon {
    width: 40px;
    height: 40px;
    font-size: 20px;
  }
  
  .comparison-prompt-title {
    font-size: 17px;
  }
  
  .comparison-prompt-desc {
    font-size: 13px;
  }
  
  .comparison-action-buttons {
    flex-direction: column;
  }
  
  .enable-comparison-btn,
  .skip-comparison-btn {
    width: 100%;
    padding: 12px 20px;
  }
  
  .year-checkboxes {
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }
  
  .year-checkbox-wrapper {
    padding: 10px;
  }
  
  .year-selection-title {
    font-size: 16px;
  }
  
  .year-selection-actions {
    flex-direction: column;
  }
  
  .quick-select-btn {
    width: 100%;
  }
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* ============================================================================
   IMAGE UPLOAD INTERFACE - Step 2 Phase 1
   ============================================================================ */

.image-upload-container {
  background: linear-gradient(135deg, #fefce8, #fef3c7);
  border: 2px solid #eab308;
  border-radius: 16px;
  padding: 24px;
  margin: 20px 0;
  display: none;
  animation: slideDown 0.4s ease-out;
}

.image-upload-container.visible {
  display: block;
}

.image-upload-title {
  font-size: 18px;
  font-weight: 700;
  color: #713f12;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.selected-years-display {
  background: white;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 16px;
  font-size: 14px;
  color: #78716c;
}

.selected-years-display strong {
  color: #713f12;
  font-weight: 600;
}

.upload-dropzone {
  border: 3px dashed #eab308;
  border-radius: 12px;
  padding: 40px;
  text-align: center;
  background: white;
  cursor: pointer;
  transition: all 0.3s;
  margin-bottom: 20px;
}

.upload-dropzone:hover {
  border-color: #ca8a04;
  background: #fefce8;
  transform: translateY(-2px);
}

.upload-dropzone.dragover {
  border-color: #16a34a;
  background: #f0fdf4;
  border-style: solid;
}

.upload-icon {
  font-size: 48px;
  margin-bottom: 12px;
}

.upload-text {
  font-size: 16px;
  font-weight: 600;
  color: #713f12;
  margin-bottom: 8px;
}

.upload-subtext {
  font-size: 13px;
  color: #78716c;
  margin-bottom: 12px;
}

.upload-specs {
  font-size: 12px;
  color: #a8a29e;
  font-style: italic;
}

#imageFileInput {
  display: none;
}

.uploaded-images-section {
  margin: 20px 0;
  display: none;
}

.uploaded-images-section.visible {
  display: block;
}

.uploaded-images-header {
  font-size: 15px;
  font-weight: 600;
  color: #713f12;
  margin-bottom: 12px;
}

.images-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}

.image-preview-card {
  position: relative;
  background: white;
  border: 2px solid #e7e5e4;
  border-radius: 12px;
  overflow: hidden;
  aspect-ratio: 1;
  transition: all 0.3s;
}

.image-preview-card:hover {
  border-color: #eab308;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(234, 179, 8, 0.2);
}

.image-preview-card img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.image-preview-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
  padding: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.image-number {
  color: white;
  font-size: 12px;
  font-weight: 600;
}

.image-size {
  color: rgba(255,255,255,0.8);
  font-size: 11px;
}

.remove-image-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 28px;
  height: 28px;
  background: rgba(239, 68, 68, 0.9);
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: bold;
  transition: all 0.3s;
  z-index: 10;
}

.remove-image-btn:hover {
  background: #dc2626;
  transform: scale(1.1);
}

.upload-actions {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.upload-action-btn {
  flex: 1;
  min-width: 140px;
  padding: 12px 20px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s;
  border: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.upload-more-btn {
  background: white;
  color: #713f12;
  border: 2px solid #eab308;
}

.upload-more-btn:hover {
  background: #fefce8;
  border-color: #ca8a04;
}

.clear-all-btn {
  background: white;
  color: #dc2626;
  border: 2px solid #fca5a5;
}

.clear-all-btn:hover {
  background: #fef2f2;
  border-color: #ef4444;
}

.process-images-btn {
  background: linear-gradient(135deg, #eab308, #ca8a04);
  color: white;
  border: none;
  box-shadow: 0 4px 12px rgba(234, 179, 8, 0.3);
}

.process-images-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(234, 179, 8, 0.4);
  background: linear-gradient(135deg, #ca8a04, #a16207);
}

.process-images-btn:disabled {
  background: linear-gradient(135deg, #d4d4d8, #a1a1aa);
  cursor: not-allowed;
  opacity: 0.6;
}

.upload-hint {
  font-size: 12px;
  color: #78716c;
  text-align: center;
  margin-top: 12px;
  font-style: italic;
}

.processing-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.processing-overlay.visible {
  display: flex;
}

.processing-content {
  background: white;
  padding: 40px;
  border-radius: 20px;
  text-align: center;
  max-width: 400px;
}

.processing-spinner {
  width: 60px;
  height: 60px;
  border: 4px solid #fef3c7;
  border-top-color: #eab308;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

.processing-title {
  font-size: 20px;
  font-weight: 700;
  color: #713f12;
  margin-bottom: 12px;
}

.processing-text {
  font-size: 14px;
  color: #78716c;
  margin-bottom: 8px;
}

.processing-progress {
  font-size: 16px;
  font-weight: 600;
  color: #eab308;
}

@media (max-width: 640px) {
  .image-upload-container {
    padding: 20px 16px;
  }
  
  .upload-dropzone {
    padding: 30px 20px;
  }
  
  .upload-icon {
    font-size: 36px;
  }
  
  .images-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .upload-actions {
    flex-direction: column;
  }
  
  .upload-action-btn {
    width: 100%;
  }
}


/* ═══════════════════════════════════════════════════════════════════
   FILE SELECTION INTERFACE - Checkbox List
   ═══════════════════════════════════════════════════════════════════ */

.file-selection-container {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  border: 2px solid #f59e0b;
  border-radius: 16px;
  padding: 24px;
  margin: 20px 0;
  max-width: 900px;
  animation: slideDown 0.4s ease-out;
}

.selection-header {
  margin-bottom: 20px;
}

.selection-title {
  font-size: 22px;
  font-weight: 700;
  color: #78350f;
  margin: 0 0 8px 0;
}

.selection-subtitle {
  font-size: 14px;
  color: #92400e;
  margin: 0;
}

.selection-stats {
  display: flex;
  gap: 24px;
  padding: 12px 16px;
  background: white;
  border-radius: 8px;
  margin-bottom: 16px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.stat-item {
  font-size: 14px;
  color: #78350f;
}

.stat-item strong {
  font-size: 18px;
  color: #f59e0b;
  font-weight: 700;
}

.files-container {
  background: white;
  border-radius: 12px;
  padding: 16px;
  max-height: 400px;
  overflow-y: auto;
  margin-bottom: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.year-group {
  margin-bottom: 16px;
  border: 1px solid #fef3c7;
  border-radius: 8px;
  overflow: hidden;
}

.year-group:last-child {
  margin-bottom: 0;
}

.year-header {
  background: linear-gradient(135deg, #fffbeb, #fef3c7);
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: background 0.3s;
}

.year-header:hover {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
}

.year-checkbox {
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.year-label {
  flex: 1;
  font-size: 15px;
  color: #78350f;
  cursor: pointer;
  margin: 0;
}

.files-list {
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.file-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  background: #fafaf9;
  border-radius: 6px;
  transition: all 0.3s;
}

.file-item:hover {
  background: #fef3c7;
  transform: translateX(4px);
}

.file-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.file-label {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  margin: 0;
}

.file-info {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 0;
  padding-left: 4px;
}

.file-icon {
  font-size: 18px;
}

.file-name {
  font-size: 13px;
  color: #44403c;
  font-family: 'Courier New', monospace;
  word-break: break-all;
}

.preview-btn {
  padding: 6px 12px;
  background: white;
  border: 1px solid #f59e0b;
  border-radius: 6px;
  color: #f59e0b;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s;
  flex-shrink: 0;
}

.preview-btn:hover {
  background: #f59e0b;
  color: white;
  transform: scale(1.05);
}

.selection-actions {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
}

.action-btn {
  flex: 1;
  padding: 14px 24px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.3s;
  border: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.secondary-btn {
  background: white;
  color: #78350f;
  border: 2px solid #fde68a;
}

.secondary-btn:hover {
  background: #fef3c7;
  border-color: #fbbf24;
  transform: translateY(-1px);
}

.primary-btn {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.primary-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
  background: linear-gradient(135deg, #d97706, #b45309);
}

.primary-btn:disabled {
  background: #e7e5e4;
  color: #a8a29e;
  cursor: not-allowed;
  box-shadow: none;
}

.selection-hint {
  font-size: 13px;
  color: #78350f;
  text-align: center;
  font-style: italic;
}

/* Scrollbar styling */
.files-container::-webkit-scrollbar {
  width: 8px;
}

.files-container::-webkit-scrollbar-track {
  background: #fef3c7;
  border-radius: 4px;
}

.files-container::-webkit-scrollbar-thumb {
  background: #fbbf24;
  border-radius: 4px;
}

.files-container::-webkit-scrollbar-thumb:hover {
  background: #f59e0b;
}

/* Mobile responsive */
@media (max-width: 640px) {
  .file-selection-container {
    padding: 16px;
    margin: 10px 0;
  }
  
  .selection-title {
    font-size: 18px;
  }
  
  .selection-stats {
    flex-direction: column;
    gap: 8px;
  }
  
  .files-container {
    max-height: 300px;
  }
  
  .file-item {
    flex-direction: column;
    align-items: stretch;
  }
  
  .file-label {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .preview-btn {
    width: 100%;
  }
  
  .selection-actions {
    flex-direction: column;
  }
  
  .action-btn {
    width: 100%;
  }
}

/* Checkbox custom styling */
input[type="checkbox"] {
  accent-color: #f59e0b;
}

/* ═══════════════════════════════════════════════════════════════════
   COPY-PASTE INTERFACE STYLES
   ═══════════════════════════════════════════════════════════════════ */

.copy-paste-container {
  background: linear-gradient(135deg, #eff6ff, #dbeafe);
  border: 2px solid #3b82f6;
  border-radius: 16px;
  padding: 24px;
  margin: 20px 0;
  max-width: 900px;
  animation: slideDown 0.4s ease-out;
}

.copy-paste-header {
  margin-bottom: 20px;
  text-align: center;
}

.copy-paste-title {
  font-size: 24px;
  font-weight: 700;
  color: #1e40af;
  margin: 0 0 8px 0;
}

.copy-paste-subtitle {
  font-size: 14px;
  color: #1e40af;
  margin: 0;
}

.copy-paste-stats {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-bottom: 20px;
}

.stat-badge {
  background: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
  color: #1e40af;
  border: 1px solid #bfdbfe;
}

.prompt-preview-container {
  background: white;
  border: 2px solid #bfdbfe;
  border-radius: 12px;
  margin-bottom: 20px;
  overflow: hidden;
}

.prompt-preview-header {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
}

.copy-btn-small {
  background: white;
  color: #2563eb;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.copy-btn-small:hover {
  transform: scale(1.05);
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.prompt-preview {
  padding: 16px;
  max-height: 300px;
  overflow-y: auto;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.6;
  color: #374151;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.prompt-preview::-webkit-scrollbar {
  width: 8px;
}

.prompt-preview::-webkit-scrollbar-track {
  background: #f3f4f6;
  border-radius: 4px;
}

.prompt-preview::-webkit-scrollbar-thumb {
  background: #3b82f6;
  border-radius: 4px;
}

.copy-paste-actions {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
}

.ai-links-container {
  background: #fef3c7;
  border: 2px solid #fbbf24;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
}

.ai-links-header {
  text-align: center;
  font-size: 14px;
  font-weight: 600;
  color: #92400e;
  margin-bottom: 12px;
}

.ai-links-buttons {
  display: flex;
  gap: 12px;
  justify-content: center;
  flex-wrap: wrap;
}

.ai-link-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 14px;
  text-decoration: none;
  transition: all 0.3s;
  flex: 1;
  min-width: 150px;
  justify-content: center;
}

.chatgpt-btn {
  background: linear-gradient(135deg, #10a37f, #0d8a6a);
  color: white;
  box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
}

.chatgpt-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(16, 163, 127, 0.4);
}

.claude-btn {
  background: linear-gradient(135deg, #cc785c, #b86749);
  color: white;
  box-shadow: 0 4px 12px rgba(204, 120, 92, 0.3);
}

.claude-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(204, 120, 92, 0.4);
}

.gemini-btn {
  background: linear-gradient(135deg, #4285f4, #1a73e8);
  color: white;
  box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
}

.gemini-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(66, 133, 244, 0.4);
}

.copy-paste-instructions {
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  padding: 16px;
}

.copy-paste-instructions h4 {
  margin: 0 0 12px 0;
  color: #1f2937;
  font-size: 16px;
}

.copy-paste-instructions ol {
  margin: 0 0 16px 0;
  padding-left: 24px;
}

.copy-paste-instructions li {
  margin: 8px 0;
  color: #4b5563;
  font-size: 14px;
}

.tip-box {
  background: #f0fdf4;
  border-left: 4px solid #10b981;
  padding: 12px;
  border-radius: 6px;
  font-size: 13px;
  color: #065f46;
}

/* Toast animation */
@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOut {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(400px);
    opacity: 0;
  }
}

/* Mobile responsive */
@media (max-width: 640px) {
  .copy-paste-container {
    padding: 16px;
    margin: 10px 0;
  }
  
  .copy-paste-title {
    font-size: 20px;
  }
  
  .copy-paste-stats {
    flex-direction: column;
    gap: 8px;
  }
  
  .prompt-preview {
    max-height: 200px;
    font-size: 12px;
  }
  
  .copy-paste-actions {
    flex-direction: column;
  }
  
  .ai-links-buttons {
    flex-direction: column;
  }
  
  .ai-link-btn {
    width: 100%;
  }
}

/* ═══════════════════════════════════════════════════════════════════
   DUAL ACTION BUTTONS (Groq vs Copy-Paste)
   ═══════════════════════════════════════════════════════════════════ */

.dual-action-container {
  background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
  border: 2px solid #0ea5e9;
  border-radius: 16px;
  padding: 24px;
  margin: 20px 0;
  animation: slideDown 0.4s ease-out;
}

.action-method-header {
  text-align: center;
  font-size: 18px;
  font-weight: 700;
  color: #0c4a6e;
  margin-bottom: 20px;
}

.action-methods {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.method-btn {
  background: white;
  border: 3px solid transparent;
  border-radius: 16px;
  padding: 24px;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.groq-method-btn {
  border-color: #10b981;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
}

.groq-method-btn:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
  border-color: #059669;
}

.copypaste-method-btn {
  border-color: #3b82f6;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
}

.copypaste-method-btn:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
  border-color: #2563eb;
}

.method-icon {
  font-size: 48px;
  text-align: center;
  margin-bottom: 12px;
}

.method-title {
  font-size: 20px;
  font-weight: 700;
  text-align: center;
  margin-bottom: 12px;
  color: #1f2937;
}

.method-description {
  font-size: 13px;
  line-height: 1.8;
  color: #6b7280;
  text-align: center;
  margin-bottom: 12px;
}

.method-badge {
  position: absolute;
  top: 12px;
  right: 12px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.method-badge.recommended {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
}

.method-badge.alternative {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
}

/* ═══════════════════════════════════════════════════════════════════
   GROQ PROCESSING OVERLAY
   ═══════════════════════════════════════════════════════════════════ */

.groq-processing-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  animation: fadeIn 0.3s;
}

.groq-processing-card {
  background: white;
  border-radius: 20px;
  padding: 40px;
  max-width: 500px;
  width: 90%;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.groq-processing-icon {
  font-size: 64px;
  margin-bottom: 20px;
  animation: pulse 2s infinite;
}

.groq-processing-title {
  font-size: 24px;
  font-weight: 700;
  color: #1f2937;
  margin: 0 0 16px 0;
}

.groq-progress-text {
  font-size: 16px;
  color: #6b7280;
  margin-bottom: 20px;
  min-height: 24px;
}

.groq-progress-bar {
  width: 100%;
  height: 8px;
  background: #e5e7eb;
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 16px;
}

.groq-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #10b981, #059669);
  width: 0%;
  transition: width 0.5s ease-out;
}

.groq-processing-note {
  font-size: 13px;
  color: #9ca3af;
  font-style: italic;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

/* ═══════════════════════════════════════════════════════════════════
   GROQ REPORT DISPLAY
   ═══════════════════════════════════════════════════════════════════ */

.groq-report-container {
  background: white;
  border-radius: 16px;
  padding: 32px;
  margin: 20px 0;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.groq-report-header {
  text-align: center;
  margin-bottom: 24px;
  padding-bottom: 24px;
  border-bottom: 3px solid #e5e7eb;
}

.groq-report-title {
  font-size: 32px;
  font-weight: 800;
  color: #1f2937;
  margin: 0 0 8px 0;
}

.groq-report-subtitle {
  font-size: 14px;
  color: #6b7280;
  font-style: italic;
}

.groq-years-badge {
  text-align: center;
  margin-bottom: 32px;
}

.years-analyzed {
  display: inline-block;
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
  padding: 12px 24px;
  border-radius: 24px;
  font-weight: 600;
  font-size: 16px;
}

.groq-year-section {
  margin-bottom: 32px;
  border-radius: 12px;
  padding: 24px;
}

.year-even {
  background: linear-gradient(135deg, #f0fdf4, #dcfce7);
  border-left: 4px solid #10b981;
}

.year-odd {
  background: linear-gradient(135deg, #eff6ff, #dbeafe);
  border-left: 4px solid #3b82f6;
}

.year-section-header {
  margin-bottom: 16px;
}

.year-title {
  font-size: 24px;
  font-weight: 700;
  color: #1f2937;
  margin: 0;
}

.year-summary {
  background: rgba(255, 255, 255, 0.8);
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 20px;
  font-size: 14px;
  color: #4b5563;
  line-height: 1.6;
}

.key-metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

.metric-card {
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 10px;
  padding: 16px;
  text-align: center;
}

.metric-label {
  font-size: 12px;
  color: #6b7280;
  text-transform: uppercase;
  font-weight: 600;
  margin-bottom: 8px;
}

.metric-value {
  font-size: 24px;
  font-weight: 700;
  color: #1f2937;
}

.categories-container {
  margin-top: 20px;
}

.category-block {
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 16px;
}

.category-name {
  font-size: 18px;
  font-weight: 700;
  color: #1f2937;
  margin: 0 0 12px 0;
  padding-bottom: 8px;
  border-bottom: 2px solid #e5e7eb;
}

.subcategories-list {
  margin: 12px 0;
}

.subcategory-item {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid #f3f4f6;
}

.subcategory-item:last-child {
  border-bottom: none;
}

.subcategory-name {
  color: #4b5563;
  font-weight: 500;
}

.subcategory-value {
  color: #1f2937;
  font-weight: 700;
}

.category-total {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 2px solid #e5e7eb;
  font-size: 16px;
  color: #1f2937;
}

.groq-insights-section {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  border: 2px solid #fbbf24;
  border-radius: 12px;
  padding: 24px;
  margin-top: 32px;
}

.insights-title {
  font-size: 22px;
  font-weight: 700;
  color: #92400e;
  margin: 0 0 16px 0;
}

.insights-list {
  margin: 0;
  padding-left: 24px;
}

.insights-list li {
  margin: 8px 0;
  color: #78350f;
  font-size: 14px;
  line-height: 1.6;
}

.groq-report-footer {
  margin-top: 32px;
  padding-top: 24px;
  border-top: 2px solid #e5e7eb;
  text-align: center;
}

.footer-timestamp {
  font-size: 13px;
  color: #6b7280;
  margin-bottom: 8px;
}

.footer-powered {
  font-size: 14px;
  color: #4b5563;
}

.groq-report-actions {
  display: flex;
  gap: 12px;
  margin-top: 24px;
  justify-content: center;
}

/* ═══════════════════════════════════════════════════════════════════
   API KEY MODAL
   ═══════════════════════════════════════════════════════════════════ */

.api-key-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  animation: fadeIn 0.3s;
}

.api-key-modal {
  background: white;
  border-radius: 20px;
  padding: 32px;
  max-width: 600px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.api-key-modal-title {
  font-size: 24px;
  font-weight: 700;
  color: #1f2937;
  margin: 0 0 20px 0;
  text-align: center;
}

.api-key-modal-content {
  font-size: 14px;
  line-height: 1.6;
  color: #4b5563;
}

.api-key-steps {
  background: #f0f9ff;
  border: 2px solid #3b82f6;
  border-radius: 10px;
  padding: 16px;
  margin: 16px 0;
}

.api-key-steps h4 {
  margin: 0 0 12px 0;
  color: #1e40af;
}

.api-key-steps ol {
  margin: 0;
  padding-left: 24px;
}

.api-key-steps li {
  margin: 8px 0;
}

.api-key-steps code {
  background: #1e293b;
  color: #f1f5f9;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 13px;
}

.api-key-benefits {
  background: #f0fdf4;
  border: 2px solid #10b981;
  border-radius: 10px;
  padding: 16px;
  margin: 16px 0;
}

.api-key-benefits h4 {
  margin: 0 0 12px 0;
  color: #065f46;
}

.api-key-benefits ul {
  margin: 0;
  padding-left: 24px;
}

.api-key-benefits li {
  margin: 6px 0;
}

.api-key-note {
  background: #fef3c7;
  border-left: 4px solid #fbbf24;
  padding: 12px;
  border-radius: 4px;
  margin: 16px 0;
  font-size: 13px;
}

.api-key-modal-actions {
  display: flex;
  gap: 12px;
  margin-top: 24px;
  justify-content: center;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .action-methods {
    grid-template-columns: 1fr;
  }
  
  .groq-report-container {
    padding: 16px;
  }
  
  .groq-report-title {
    font-size: 24px;
  }
  
  .key-metrics-grid {
    grid-template-columns: 1fr;
  }
  
  .groq-report-actions {
    flex-direction: column;
  }
}
</style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">
  <div class="om-symbol om-top-right devanagari">ॐ</div>
  <div class="om-symbol om-bottom-left devanagari">ॐ</div>

  <div class="container-main w-full max-w-5xl glass-card rounded-3xl shadow-2xl overflow-hidden">
    <div class="relative bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50 p-6 pb-4 text-center header-glow">
      <div class="flex justify-between items-start mb-4 w-full">
 <button onclick="openPDFGuide()" class="live-telecast-btn" style="background: linear-gradient(135deg, #2563eb, #3b82f6);">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" class="w-5 h-5">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
    </svg>
    Tutorial Guide
  </button>
      </div>
      
      <div class="floating">
        <h1 class="text-5xl md:text-6xl font-black gradient-text mb-2 playfair tracking-tight">Haryana DataVista
</h1>
      </div>
      <p class="text-sm text-gray-600 font-semibold mb-3 tracking-wide">Statistical Abstract Chatbot</p>
      
      <div class="w-full max-w-2xl mx-auto px-4">
<!-- SOLUTION 2: Conditional nowrap (Better for very small screens) -->
<div class="bg-white rounded-2xl border-3 border-orange-400 py-2 px-4 shadow-xl transform hover:scale-105 transition-all duration-300">
  <h2 class="text-xs sm:text-sm md:text-base lg:text-lg font-black text-center bg-gradient-to-r from-orange-600 via-orange-500 to-amber-600 bg-clip-text text-transparent sm:whitespace-nowrap leading-tight">
    Department of Economic and Statistical Analysis, Haryana
  </h2>
</div>
      </div>
     </div>

    <div class="p-2">
      <div class="query-type-selector">
        <h3 class="text-xl font-bold text-gray-900 mb-4 text-center flex items-center justify-center gap-2">
          <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          Area of interest?
        </h3>
        
        <div class="radio-option" onclick="selectQueryType('statistics')">
          <input type="radio" name="queryType" id="statisticsRadio" value="statistics">
          <span class="radio-icon">📖</span>
          <label for="statisticsRadio" class="radio-label cursor-pointer">
            <span class="radio-label-title">Learn About Statistics</span>
            <span class="radio-label-desc">Get explanations about statistical terms and concepts</span>
          </label>
        </div>
        
        <div class="radio-option" onclick="selectQueryType('data')">
          <input type="radio" name="queryType" id="dataRadio" value="data">
          <span class="radio-icon">📊</span>
          <label for="dataRadio" class="radio-label cursor-pointer">
            <span class="radio-label-title">Find Haryana Data</span>
            <span class="radio-label-desc">Search for specific data from Haryana Statistical Abstract</span>
          </label>
        </div>
      </div>

      <div id="questionSection" style="display: none;">
        <div class="mb-8 slide-fade-enter">
          <div class="relative autocomplete-container">
            <textarea
              id="userInput"
              rows="3"
              class="w-full rounded-2xl border-4 border-orange-400 p-4 pb-12 text-gray-900
                     bg-gradient-to-br from-white to-orange-50 shadow-2xl resize-none
                     focus:border-orange-500 focus:ring-4 focus:ring-orange-200 focus:shadow-2xl
                     transition-all duration-300 leading-relaxed"
              placeholder="Type your question here... (e.g., What is literacy rate? Show district-wise population)"
            ></textarea>
            <div id="autocompleteDropdown" class="autocomplete-dropdown" style="display: none;"></div>
            <button
              id="voiceBtn"
              class="mic-btn absolute bottom-3 right-3 text-orange-500 hover:text-orange-700 transition-all duration-300 hover:scale-110 bg-white rounded-full p-3 shadow-lg border-2 border-orange-300"
              title="Click to speak"
            >
              <svg id="micIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="mb-8 slide-fade-enter" id="quickQuestionsSection">
          <div class="flex items-center justify-between mb-4">
            <label class="text-lg font-bold text-gray-800">Quick help👇</label>
              <div class="flex justify-end mb-2">
                <div class="lang-toggle">
                  <button class="langBtn active" data-lang="English">English</button>
                  <button class="langBtn" data-lang="Hindi">हिंदी</button>
                </div>
              </div>  
          </div>
          <div class="space-y-4">
            <select id="categorySelect" class="block w-full px-5 py-4 text-base border-2 border-gray-200 focus:outline-none focus:ring-3 focus:ring-blue-500 focus:border-blue-500 rounded-2xl bg-white shadow-md transition-all duration-300 font-medium">
              <option value="" selected disabled>Select Topic</option>
            </select>
            <select id="questionSelect" class="block w-full px-5 py-4 text-base border-2 border-gray-200 focus:outline-none focus:ring-3 focus:ring-blue-500 focus:border-blue-500 rounded-2xl bg-white shadow-md transition-all duration-300 font-medium" disabled>
                <option value="" selected disabled>Select Question</option>
            </select> 
          </div>
        </div>
        <!-- File search section removed - use main chat input only -->

        

        <button 
          id="submitBtn" 
          class="w-full mt-4 btn-primary flex items-center justify-center gap-3 text-xl slide-fade-enter"
        >
          <svg class="icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
          Submit
        </button>
      </div>


<div class="grid grid-cols-1 sm:grid-cols-2 
            md:grid-cols-none md:grid-flow-col md:auto-cols-max
            gap-4 md:gap-6 mb-4 mt-4 px-2">

  <!-- Haryana Statistical Abstract -->
  <a href="https://esaharyana.gov.in/statistical-wing-publication-reports/" 
     target="_blank" class="block">
    <div class="event-card bg-gradient-to-br from-blue-50 to-blue-100 border-l-4 border-blue-600 
                shadow-lg rounded-xl p-5 hover:shadow-xl transition-all duration-300 hover:scale-105 cursor-pointer">
      <div class="flex items-center gap-3 mb-3">
        <svg class="w-10 h-10 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        <div class="flex-1">
          <p class="font-bold text-gray-900 text-base">Haryana Statistical Abstract</p>
          <p class="text-xs text-gray-600 font-medium">हरियाणा सांख्यिकीय सार</p>
        </div>
      </div>
    </div>
  </a>

  <!-- India Statistics -->
  <a href="https://www.mospi.gov.in/publications-reports" 
     target="_blank" class="block">
    <div class="event-card bg-gradient-to-br from-green-50 to-green-100 border-l-4 border-green-600 
                shadow-lg rounded-xl p-5 hover:shadow-xl transition-all duration-300 hover:scale-105 cursor-pointer">
      <div class="flex items-center gap-3 mb-3">
<svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M12 8c1.657 0 3-1.343 3-3S13.657 2 12 2 9 3.343 9 5s1.343 3 3 3zm7 8c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 
           1.343-3 3 1.343 3 3 3zm-14 0c1.657 0 3-1.343 3-3S6.657 10 5 10s-3 1.343-3 3 1.343 3 3 3zm10-6l3 2m-6-2l-3 2m3 4v4"/>
</svg>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064"/>
        </svg>
        <div class="flex-1">
          <p class="font-bold text-gray-900 text-base">India Statistics</p>
          <p class="text-xs text-gray-600 font-medium">भारत सांख्यिकी</p>
        </div>
      </div>
    </div>
  </a>

<!-- Cards 3 & 4 wrapped in 2-column grid on mobile -->
<div class="grid grid-cols-2 gap-4 sm:grid-cols-2 md:grid-cols-none md:grid-flow-col md:auto-cols-max">

  <!-- Census Data Card -->
  <a href="https://censusindia.gov.in/" target="_blank" class="block">
    <div class="event-card bg-gradient-to-br from-purple-50 to-purple-100 border-l-4 border-purple-600 
                shadow-lg rounded-xl p-5 hover:shadow-xl transition-all duration-300 hover:scale-105 cursor-pointer">
      <div class="flex items-center gap-3 mb-3">
<svg class="w-10 h-10 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M7 20v-2a4 4 0 118 0v2m5 0v-2a5 5 0 00-10 0v2M12 11a3 3 0 100-6 3 3 0 000 6z"/>
</svg>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857..."/>
        </svg>
        <div class="flex-1">
          <p class="font-bold text-gray-900 text-base">Census Data</p>
          <p class="text-xs text-gray-600 font-medium">जनगणना डेटा</p>
        </div>
      </div>
    </div>
  </a>

  <!-- Open Data Portal Card -->
  <a href="https://data.gov.in/" target="_blank" class="block">
    <div class="event-card bg-gradient-to-br from-orange-50 to-orange-100 border-l-4 border-orange-600 
                shadow-lg rounded-xl p-5 hover:shadow-xl transition-all duration-300 hover:scale-105 cursor-pointer">
      <div class="flex items-center gap-3 mb-3">
<svg class="w-10 h-10 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M12 3a9 9 0 100 18 9 9 0 000-18zm0 0c2.5 2 4 5.5 4 9s-1.5 7-4 9m0-18c-2.5 2-4 5.5-4 9s1.5 7 4 9m-9-9h18"/>
</svg>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79..."/>
        </svg>
        <div class="flex-1">
          <p class="font-bold text-gray-900 text-base">Open Data</p>
          <p class="text-xs text-gray-600 font-medium">खुला डेटा</p>
        </div>
      </div>
    </div>
  </a>

</div>

</div>

      <div class="quote-section mb-1">
        <p class="text-xl text-gray-900 text-center leading-relaxed mb-2 relative z-10 font-semibold italic">
          "Without data, you're just another person with an opinion."
        </p>
        <p class="text-right text-gray-600 text-sm mb-1 mt-1 font-medium">– W. Edwards Deming</p>
        <p class="text-center text-sm text-gray-700 mb-0 mt-2 font-light leading-relaxed">
         <span style="line-height: 1.2; display: block;">Statistics illuminate the path from confusion to clarity,<br>transforming raw numbers into meaningful insights for progress.</span>
        </p>
      </div>

      <div class="mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
        <button onclick="openFeedback()" class="feedback-btn">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
          </svg>
          Feedback
        </button>
        
        <a href="https://esaharyana.gov.in/" class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-800 font-semibold transition-all hover:scale-105">
          <svg class="icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
          </svg>
          Visit ESA Haryana
        </a>
      </div>
    </div>
    
  <div class="border-t-2 border-gray-200 px-6 py-4 text-center bg-gradient-to-b from-gray-50 to-white">
<p class="text-sm text-gray-700 mb-2 font-medium">AI Chatbot powered by <span class="font-bold text-orange-600">Groq + Llama 3.3</span></p>
<p class="text-gray-500 text-xs mb-3">Last Updated: <span id="lastModified" style="display: inline;">Loading...</span></p>      <div class="flex flex-wrap justify-center items-center gap-6">
        <img src="https://raw.githubusercontent.com/vksinglakkr/IGM2025/main/Images/haryana-logo.jpg" alt="Haryana" class="w-16 h-16 object-contain opacity-80 hover:opacity-100 transition-all hover:scale-110">
      </div>
    </div>
  </div>

  <div id="aiModal" class="hidden fixed inset-0 flex items-center justify-center p-2" style="z-index: 9999; background: rgba(0,0,0,0.92);">
    <div class="bg-white rounded-3xl shadow-2xl w-full mx-2 modal-enter overflow-hidden" style="max-width: 850px; max-height: 92vh;">
      <div class="flex justify-between items-center px-5 py-4 bg-gradient-to-r from-blue-600 to-indigo-700 text-white">
        <h2 class="text-xl font-bold flex items-center gap-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
          AI Response
        </h2>
        <button id="closeModal" class="hover:bg-white/20 p-2 rounded-full transition">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>

<!-- ENHANCED VERSION WITH RELATED QUESTIONS -->
<div class="p-5 overflow-y-auto bg-gray-50" style="max-height: calc(92vh - 180px);">
  <div class="mb-5">
    <div class="flex items-center gap-2 mb-2">
      <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      <p class="font-bold text-gray-900">Question:</p>
      <span id="historyBadge" class="hidden bg-purple-100 text-purple-700 px-2 py-1 rounded-full text-xs font-bold ml-auto">
        📚 Conversation: <span id="historyCount">0</span> prev
      </span>
    </div>
    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-2xl border-l-4 border-blue-500">
      <pre id="modalQuestion" class="whitespace-pre-wrap text-gray-800 leading-relaxed"></pre> 
    </div>
  </div>

  <div>
    <div class="flex items-center justify-between mb-2 flex-wrap gap-2">
      <div class="flex items-center gap-2">
        <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
        <p class="font-bold text-gray-900">Answer:</p>
      </div>
      <button id="ttsToggle" class="tts-btn bg-gradient-to-r from-orange-500 to-orange-600 text-white">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg>
        <span id="ttsLabel">Listen</span>
      </button>
    </div>
    <div class="bg-gradient-to-br from-amber-50 to-orange-50 p-4 rounded-2xl border-l-4 border-orange-500">
      <pre id="modalAnswer" class="whitespace-pre-wrap text-gray-800 text-sm leading-loose devanagari"></pre>
    </div>
  </div>

  <!-- ✅ NEW: RELATED QUESTIONS SECTION -->
  <div id="relatedQuestionsSection" class="mt-6" style="display: none;">
    <div class="flex items-center gap-2 mb-3">
      <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
      </svg>
      <p class="font-bold text-gray-900">Related Questions:</p>
    </div>
    <div id="relatedQuestionsList" class="space-y-2">
      <!-- Related questions will be inserted here -->
    </div>
  </div>
</div>
      <div class="border-t-2 border-gray-200 p-3 bg-white flex justify-center gap-2">
<button id="whatsappBtn" class="flex items-center gap-1 px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-xl transition text-sm font-semibold">
  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
  </svg>
  Share on WhatsApp
</button>
        <button onclick="openFeedback()" class="feedback-btn feedback-btn-small">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
          </svg>
          Rate Us
        </button>
 <button id="newTopicBtn" class="flex items-center gap-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-2.5 rounded-xl hover:from-blue-700 hover:to-blue-800 transition text-sm font-bold shadow-lg" title="Start a new conversation topic">
  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
  </svg>
  New Topic
</button>
        <button id="closeBtn" class="flex items-center gap-1 bg-gradient-to-r from-blue-600 to-blue-700 text-white px-5 py-2 rounded-xl hover:from-blue-700 hover:to-blue-800 transition text-sm font-bold shadow-lg">
          Close
        </button>
      </div>
    </div>
  </div>

  <div id="feedbackModal">
    <div class="feedback-modal-content">
      <div class="feedback-modal-header">
        <h2 class="text-xl font-bold flex items-center gap-1">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
          </svg>
          Feedback
        </h2>
        <button onclick="closeFeedback()" class="feedback-modal-close">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      
      <div style="position: relative; flex: 1;">
        <div id="iframeLoader" class="iframe-loader" style="display: none;">
          <div class="spinner"></div>
          <p style="color: #64748b; font-weight: 600;">Loading feedback form...</p>
        </div>
        <iframe id="feedbackIframe" src=""></iframe>
      </div>
    </div>
  </div>

  <div id="quizModal">
    <div class="quiz-modal-content">
      <div class="quiz-modal-header">
        <h2 class="text-xl font-bold flex items-center gap-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
          </svg>
          🎥 Tutorial Videos
        </h2>
        <button onclick="closeTutorialVideos()" class="quiz-modal-close">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      
      <div style="position: relative; flex: 1; overflow-y: auto; padding: 20px;">
        <div class="space-y-4">
          <!-- Video 1 -->
          <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-5 rounded-xl border-l-4 border-blue-500 hover:shadow-lg transition-all">
            <h3 class="font-bold text-blue-900 text-lg mb-2 flex items-center gap-2">
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"/>
              </svg>
              Getting Started with STATS SAHAYAK
            </h3>
            <p class="text-gray-700 text-sm mb-3">Learn the basics of using the chatbot</p>
            <a href="https://www.youtube.com/watch?v=YOUR_VIDEO_ID_1" target="_blank" 
               class="inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm font-semibold">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"/>
              </svg>
              Watch Tutorial (5 min)
            </a>
          </div>

          <!-- Video 2 -->
          <div class="bg-gradient-to-r from-green-50 to-green-100 p-5 rounded-xl border-l-4 border-green-500 hover:shadow-lg transition-all">
            <h3 class="font-bold text-green-900 text-lg mb-2 flex items-center gap-2">
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"/>
              </svg>
              Finding Statistical Data
            </h3>
            <p class="text-gray-700 text-sm mb-3">How to search for district-wise data and reports</p>
            <a href="https://www.youtube.com/watch?v=YOUR_VIDEO_ID_2" target="_blank" 
               class="inline-flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm font-semibold">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"/>
              </svg>
              Watch Tutorial (7 min)
            </a>
          </div>

          <!-- Video 3 -->
          <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-5 rounded-xl border-l-4 border-purple-500 hover:shadow-lg transition-all">
            <h3 class="font-bold text-purple-900 text-lg mb-2 flex items-center gap-2">
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"/>
              </svg>
              Advanced Features
            </h3>
            <p class="text-gray-700 text-sm mb-3">Voice input, language toggle, and more</p>
            <a href="https://www.youtube.com/watch?v=YOUR_VIDEO_ID_3" target="_blank" 
               class="inline-flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm font-semibold">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"/>
              </svg>
              Watch Tutorial (6 min)
            </a>
          </div>

          <!-- Video 4 -->
          <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-5 rounded-xl border-l-4 border-orange-500 hover:shadow-lg transition-all">
            <h3 class="font-bold text-orange-900 text-lg mb-2 flex items-center gap-2">
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"/>
              </svg>
              Understanding Statistical Reports
            </h3>
            <p class="text-gray-700 text-sm mb-3">Learn to interpret data and generate insights</p>
            <a href="https://www.youtube.com/watch?v=YOUR_VIDEO_ID_4" target="_blank" 
               class="inline-flex items-center gap-2 bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors text-sm font-semibold">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"/>
              </svg>
              Watch Tutorial (8 min)
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// ============================================================================
// COMPREHENSIVE STATISTICAL QUESTIONS - DIRECT REPLACEMENT CODE
// Copy lines 1527-1600 and replace with this entire code block
// ============================================================================

const statsQuestions = {
  '📊 Basic Statistical Concepts': {
    '🔢 Fundamental Terms': [
      "What is statistics?",
      "What is data?",
      "What is population in statistics?",
      "What is a sample?",
      "What is census?",
      "What is the difference between census and sample survey?",
      "What is a variable?",
      "What is qualitative data?",
      "What is quantitative data?"
    ],
    '📈 Central Tendency': [
      "What is mean?",
      "What is median?",
      "What is mode?",
      "What is the difference between mean, median, and mode?",
      "What is weighted mean?",
      "What is percentile?",
      "What is quartile?"
    ],
    '📉 Dispersion Measures': [
      "What is range in statistics?",
      "What is variance?",
      "What is standard deviation?",
      "What is coefficient of variation?",
      "What is quartile deviation?"
    ]
  },

  '👥 Population Statistics': {
    '🌍 Population Basics': [
      "What is population?",
      "What is population density?",
      "How is population density calculated?",
      "What is crude birth rate?",
      "What is crude death rate?",
      "What is natural growth rate?",
      "What is population growth rate?",
      "What is decadal growth rate?"
    ],
    '👶 Birth & Death': [
      "What is birth rate?",
      "What is death rate?",
      "What is infant mortality rate?",
      "What is child mortality rate?",
      "What is maternal mortality rate?",
      "What is fertility rate?",
      "What is total fertility rate (TFR)?",
      "What is life expectancy?"
    ],
    '🚻 Sex Ratio & Age': [
      "What is sex ratio?",
      "How is sex ratio calculated?",
      "What is child sex ratio?",
      "What is dependency ratio?",
      "What is working age population?",
      "What is age pyramid?"
    ],
    '🏘️ Rural-Urban': [
      "What is rural population?",
      "What is urban population?",
      "What is urbanization?",
      "What is urban agglomeration?",
      "What is metropolitan city?"
    ]
  },

  '📚 Literacy & Education': {
    '📖 Literacy': [
      "What is literacy rate?",
      "How is literacy rate calculated?",
      "What is male literacy rate?",
      "What is female literacy rate?",
      "What is adult literacy rate?",
      "What is functional literacy?"
    ],
    '🎓 Education Indicators': [
      "What is gross enrollment ratio (GER)?",
      "What is net enrollment ratio (NER)?",
      "What is dropout rate?",
      "What is pupil-teacher ratio?",
      "What is gender parity index in education?"
    ]
  },

  '💰 Economic Statistics': {
    '💵 GDP & Income': [
      "What is Gross Domestic Product (GDP)?",
      "What is per capita income?",
      "What is GSDP?",
      "What is national income?",
      "What is real GDP?",
      "What is nominal GDP?",
      "What is GDP growth rate?"
    ],
    '📊 Price Indices': [
      "What is a Price Index?",
      "What is Consumer Price Index (CPI)?",
      "What is Wholesale Price Index (WPI)?",
      "What is inflation?",
      "What is base year?",
      "What is current price?",
      "What is constant price?"
    ],
    '💼 Employment': [
      "What is unemployment rate?",
      "What is labor force participation rate?",
      "What is work participation rate?",
      "What is workforce?"
    ],
    '🏚️ Poverty': [
      "What is poverty line?",
      "What is poverty ratio?",
      "What is Below Poverty Line (BPL)?",
      "What is Gini coefficient?"
    ]
  },

  '🌾 Agriculture Statistics': {
    '🚜 Land Use': [
      "What is geographical area?",
      "What is net sown area?",
      "What is gross sown area?",
      "What is cropped area?",
      "What is cropping intensity?",
      "What is cultivable land?",
      "What is fallow land?"
    ],
    '🌱 Crop Production': [
      "What is yield?",
      "What is crop yield?",
      "What is productivity?",
      "What is Kharif crop?",
      "What is Rabi crop?",
      "What is food grain?",
      "What is cash crop?"
    ],
    '🐄 Livestock': [
      "What is livestock census?",
      "What is cattle population?",
      "What is milk production?",
      "What is poultry population?"
    ],
    '💧 Irrigation': [
      "What is irrigated area?",
      "What is net irrigated area?",
      "What is irrigation intensity?",
      "What is canal irrigation?",
      "What is tube well irrigation?"
    ]
  },

  '🏭 Industry & Manufacturing': {
    '🏗️ Industrial': [
      "What is Index of Industrial Production (IIP)?",
      "What is manufacturing sector?",
      "What is factory?",
      "What is registered factory?",
      "What is industrial growth rate?"
    ],
    '⚡ Power & Energy': [
      "What is installed capacity?",
      "What is power generation?",
      "What is per capita power consumption?",
      "What is rural electrification?"
    ]
  },

  '🏥 Health Statistics': {
    '👨‍⚕️ Health Indicators': [
      "What is morbidity rate?",
      "What is prevalence?",
      "What is incidence?",
      "What is malnutrition?",
      "What is stunting?",
      "What is wasting?"
    ],
    '🏥 Healthcare': [
      "What is bed-population ratio?",
      "What is doctor-population ratio?",
      "What is primary health center?",
      "What is immunization coverage?",
      "What is institutional delivery?"
    ]
  },

  '🚗 Infrastructure': {
    '🛣️ Roads': [
      "What is road density?",
      "What is road length?",
      "What is national highway?",
      "What is state highway?",
      "What is village connectivity?"
    ],
    '📱 Telecom & Banking': [
      "What is teledensity?",
      "What is mobile penetration?",
      "What is internet penetration?",
      "What is bank branch density?",
      "What is credit-deposit ratio?"
    ]
  },

  '🏛️ Administrative': {
    '📍 Units': [
      "What is district?",
      "What is tehsil?",
      "What is block?",
      "What is gram panchayat?",
      "What is municipality?"
    ],
    '📊 Census Methods': [
      "What is census enumeration?",
      "What is household?",
      "What is household size?",
      "What is reference period?"
    ]
  },

  '🌳 Environment': {
    '🌲 Forest & Climate': [
      "What is forest cover?",
      "What is forest density?",
      "What is rainfall?",
      "What is average rainfall?",
      "What is drought?"
    ]
  },

  '🔢 Advanced Methods': {
    '📐 Analysis': [
      "What is correlation?",
      "What is regression analysis?",
      "What is trend analysis?",
      "What is forecasting?",
      "What is probability?"
    ]
  }
};

// ============================================================================
// HINDI VERSION
// ============================================================================

const statsQuestionsHindi = {
  '📊 बुनियादी सांख्यिकीय अवधारणाएं': {
    '🔢 मूल शब्दावली': [
      "सांख्यिकी क्या है?",
      "डेटा क्या है?",
      "सांख्यिकी में जनसंख्या क्या है?",
      "नमूना क्या है?",
      "जनगणना क्या है?",
      "जनगणना और नमूना सर्वेक्षण में क्या अंतर है?",
      "चर क्या है?",
      "गुणात्मक डेटा क्या है?",
      "मात्रात्मक डेटा क्या है?"
    ],
    '📈 केंद्रीय प्रवृत्ति': [
      "माध्य क्या है?",
      "मध्यिका क्या है?",
      "बहुलक क्या है?",
      "माध्य, मध्यिका और बहुलक में क्या अंतर है?",
      "भारित माध्य क्या है?",
      "प्रतिशतक क्या है?",
      "चतुर्थक क्या है?"
    ],
    '📉 प्रकीर्णन के माप': [
      "सांख्यिकी में परिसर क्या है?",
      "प्रसरण क्या है?",
      "मानक विचलन क्या है?",
      "विचलन गुणांक क्या है?",
      "चतुर्थक विचलन क्या है?"
    ]
  },

  '👥 जनसंख्या सांख्यिकी': {
    '🌍 जनसंख्या मूल': [
      "जनसंख्या क्या है?",
      "जनसंख्या घनत्व क्या है?",
      "जनसंख्या घनत्व की गणना कैसे की जाती है?",
      "कच्ची जन्म दर क्या है?",
      "कच्ची मृत्यु दर क्या है?",
      "प्राकृतिक वृद्धि दर क्या है?",
      "जनसंख्या वृद्धि दर क्या है?",
      "दशकीय वृद्धि दर क्या है?"
    ],
    '👶 जन्म और मृत्यु': [
      "जन्म दर क्या है?",
      "मृत्यु दर क्या है?",
      "शिशु मृत्यु दर क्या है?",
      "बाल मृत्यु दर क्या है?",
      "मातृ मृत्यु दर क्या है?",
      "प्रजनन दर क्या है?",
      "कुल प्रजनन दर (TFR) क्या है?",
      "जीवन प्रत्याशा क्या है?"
    ],
    '🚻 लिंगानुपात और आयु': [
      "लिंगानुपात क्या है?",
      "लिंगानुपात की गणना कैसे की जाती है?",
      "बाल लिंगानुपात क्या है?",
      "निर्भरता अनुपात क्या है?",
      "कार्यशील आयु जनसंख्या क्या है?",
      "आयु पिरामिड क्या है?"
    ],
    '🏘️ ग्रामीण-शहरी': [
      "ग्रामीण जनसंख्या क्या है?",
      "शहरी जनसंख्या क्या है?",
      "शहरीकरण क्या है?",
      "शहरी समूहन क्या है?",
      "महानगरीय शहर क्या है?"
    ]
  },

  '📚 साक्षरता और शिक्षा': {
    '📖 साक्षरता': [
      "साक्षरता दर क्या है?",
      "साक्षरता दर की गणना कैसे की जाती है?",
      "पुरुष साक्षरता दर क्या है?",
      "महिला साक्षरता दर क्या है?",
      "वयस्क साक्षरता दर क्या है?",
      "कार्यात्मक साक्षरता क्या है?"
    ],
    '🎓 शिक्षा संकेतक': [
      "सकल नामांकन अनुपात (GER) क्या है?",
      "शुद्ध नामांकन अनुपात (NER) क्या है?",
      "ड्रॉपआउट दर क्या है?",
      "छात्र-शिक्षक अनुपात क्या है?",
      "शिक्षा में लैंगिक समानता सूचकांक क्या है?"
    ]
  },

  '💰 आर्थिक सांख्यिकी': {
    '💵 GDP और आय': [
      "सकल घरेलू उत्पाद (GDP) क्या है?",
      "प्रति व्यक्ति आय क्या है?",
      "GSDP क्या है?",
      "राष्ट्रीय आय क्या है?",
      "वास्तविक GDP क्या है?",
      "नाममात्र GDP क्या है?",
      "GDP वृद्धि दर क्या है?"
    ],
    '📊 मूल्य सूचकांक': [
      "मूल्य सूचकांक क्या है?",
      "उपभोक्ता मूल्य सूचकांक (CPI) क्या है?",
      "थोक मूल्य सूचकांक (WPI) क्या है?",
      "मुद्रास्फीति क्या है?",
      "आधार वर्ष क्या है?",
      "वर्तमान मूल्य क्या है?",
      "स्थिर मूल्य क्या है?"
    ],
    '💼 रोजगार': [
      "बेरोजगारी दर क्या है?",
      "श्रम बल भागीदारी दर क्या है?",
      "कार्य भागीदारी दर क्या है?",
      "कार्यबल क्या है?"
    ],
    '🏚️ गरीबी': [
      "गरीबी रेखा क्या है?",
      "गरीबी अनुपात क्या है?",
      "गरीबी रेखा से नीचे (BPL) क्या है?",
      "गिनी गुणांक क्या है?"
    ]
  },

  '🌾 कृषि सांख्यिकी': {
    '🚜 भूमि उपयोग': [
      "भौगोलिक क्षेत्र क्या है?",
      "शुद्ध बोया गया क्षेत्र क्या है?",
      "सकल बोया गया क्षेत्र क्या है?",
      "फसली क्षेत्र क्या है?",
      "फसल सघनता क्या है?",
      "कृषि योग्य भूमि क्या है?",
      "परती भूमि क्या है?"
    ],
    '🌱 फसल उत्पादन': [
      "उपज क्या है?",
      "फसल उपज क्या है?",
      "उत्पादकता क्या है?",
      "खरीफ फसल क्या है?",
      "रबी फसल क्या है?",
      "खाद्यान्न क्या है?",
      "नकदी फसल क्या है?"
    ],
    '🐄 पशुधन': [
      "पशुधन जनगणना क्या है?",
      "पशु जनसंख्या क्या है?",
      "दुग्ध उत्पादन क्या है?",
      "कुक्कुट जनसंख्या क्या है?"
    ],
    '💧 सिंचाई': [
      "सिंचित क्षेत्र क्या है?",
      "शुद्ध सिंचित क्षेत्र क्या है?",
      "सिंचाई सघनता क्या है?",
      "नहर सिंचाई क्या है?",
      "नलकूप सिंचाई क्या है?"
    ]
  },

  '🏭 उद्योग और विनिर्माण': {
    '🏗️ औद्योगिक': [
      "औद्योगिक उत्पादन सूचकांक (IIP) क्या है?",
      "विनिर्माण क्षेत्र क्या है?",
      "कारखाना क्या है?",
      "पंजीकृत कारखाना क्या है?",
      "औद्योगिक वृद्धि दर क्या है?"
    ],
    '⚡ बिजली और ऊर्जा': [
      "स्थापित क्षमता क्या है?",
      "बिजली उत्पादन क्या है?",
      "प्रति व्यक्ति बिजली खपत क्या है?",
      "ग्रामीण विद्युतीकरण क्या है?"
    ]
  },

  '🏥 स्वास्थ्य सांख्यिकी': {
    '👨‍⚕️ स्वास्थ्य संकेतक': [
      "रुग्णता दर क्या है?",
      "व्यापकता क्या है?",
      "घटना क्या है?",
      "कुपोषण क्या है?",
      "बौनापन क्या है?",
      "क्षीणता क्या है?"
    ],
    '🏥 स्वास्थ्य सेवा': [
      "बिस्तर-जनसंख्या अनुपात क्या है?",
      "डॉक्टर-जनसंख्या अनुपात क्या है?",
      "प्राथमिक स्वास्थ्य केंद्र क्या है?",
      "टीकाकरण कवरेज क्या है?",
      "संस्थागत प्रसव क्या है?"
    ]
  },

  '🚗 बुनियादी ढांचा': {
    '🛣️ सड़कें': [
      "सड़क घनत्व क्या है?",
      "सड़क लंबाई क्या है?",
      "राष्ट्रीय राजमार्ग क्या है?",
      "राज्य राजमार्ग क्या है?",
      "गांव कनेक्टिविटी क्या है?"
    ],
    '📱 दूरसंचार और बैंकिंग': [
      "टेलीडेंसिटी क्या है?",
      "मोबाइल पैठ क्या है?",
      "इंटरनेट पैठ क्या है?",
      "बैंक शाखा घनत्व क्या है?",
      "ऋण-जमा अनुपात क्या है?"
    ]
  },

  '🏛️ प्रशासनिक': {
    '📍 इकाइयां': [
      "जिला क्या है?",
      "तहसील क्या है?",
      "ब्लॉक क्या है?",
      "ग्राम पंचायत क्या है?",
      "नगरपालिका क्या है?"
    ],
    '📊 जनगणना विधियां': [
      "जनगणना गणना क्या है?",
      "परिवार क्या है?",
      "परिवार का आकार क्या है?",
      "संदर्भ अवधि क्या है?"
    ]
  },

  '🌳 पर्यावरण': {
    '🌲 वन और जलवायु': [
      "वन आच्छादन क्या है?",
      "वन घनत्व क्या है?",
      "वर्षा क्या है?",
      "औसत वर्षा क्या है?",
      "सूखा क्या है?"
    ]
  },

  '🔢 उन्नत विधियां': {
    '📐 विश्लेषण': [
      "सहसंबंध क्या है?",
      "प्रतिगमन विश्लेषण क्या है?",
      "प्रवृत्ति विश्लेषण क्या है?",
      "पूर्वानुमान क्या है?",
      "प्रायिकता क्या है?"
    ]
  }
};

let selectedLanguage = 'English';
let selectedQueryType = null; // ✅ FIX: No default selection - user must choose
let currentQuestions = {};
let allQuestions = [];
// ═══════════════════════════════════════════════════════════════════
// GOOGLE SHEETS CONFIGURATION
// ═══════════════════════════════════════════════════════════════════
const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/17mpGz4-lw-xBYqDiHj7RV1z0w_5k8lEmSmVqsxS36ro/export?format=tsv&gid=740242886';

// File Search Variables - LOADED FROM GOOGLE SHEETS (TSV FORMAT)
let masterFileData = [];
let selectedFileItem = null;
    
// ═══════════════════════════════════════════════════════════════════
// COMPREHENSIVE DEBUG LOGGING
// ═══════════════════════════════════════════════════════════════════
console.log('════════════════════════════════════════════════════════');
console.log('🔍 STATS SAHAYAK DEBUG MODE');
console.log('════════════════════════════════════════════════════════');
console.log('✓ Script loading started');
console.log('✓ GOOGLE_SHEET_URL:', GOOGLE_SHEET_URL);
console.log('✓ Document ready state:', document.readyState);
console.log('════════════════════════════════════════════════════════');

const FILE_API_ENDPOINT = 'https://n8n-workflow-test.duckdns.org/webhook/stat-abstract'; // ⚠️ ADD YOUR N8N WEBHOOK URL    

// DOM elements - will be accessed when needed (after page loads)
let categorySelect;
let questionSelect;
let questionSection;
let userInput;
let autocompleteDropdown;

// Initialize DOM elements after page loads
function initDOMElements() {
  categorySelect = document.getElementById('categorySelect');
  questionSelect = document.getElementById('questionSelect');
  questionSection = document.getElementById('questionSection');
  userInput = document.getElementById('userInput');
  autocompleteDropdown = document.getElementById('autocompleteDropdown');
}

// ============================================================================
// STATABS CHATBOT - CORRECTED FUNCTION UPDATES
// ============================================================================
// Copy your original HTML file and replace these functions with the code below
// ============================================================================

// FUNCTION 1: selectQueryType (Replace around line 1595)
// ============================================================================
function selectQueryType(type) {
  console.log('🔘 selectQueryType called with:', type);
  
  // Always ensure DOM elements are initialized
  if (!categorySelect || !questionSection) {
    console.log('   Initializing DOM elements...');
    initDOMElements();
  }
  
  console.log('   DOM elements status:', {
    categorySelect: !!categorySelect,
    questionSelect: !!questionSelect,
    questionSection: !!questionSection,
    userInput: !!userInput,
    autocompleteDropdown: !!autocompleteDropdown
  });
  
  selectedQueryType = type;
  console.log('   selectedQueryType set to:', selectedQueryType);
  
  document.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
  const clickedOption = type === 'statistics' ? 
    document.querySelector('.radio-option:first-of-type') : 
    document.querySelector('.radio-option:last-of-type');
  clickedOption.classList.add('selected');
  
  // ✅ FIX 1: Clear textbox when switching radio buttons
  userInput.value = '';
  autocompleteDropdown.style.display = 'none';
  
  if (type === 'statistics') {
    document.getElementById('statisticsRadio').checked = true;
    document.getElementById('userInput').placeholder = 'Type your question here...';
    
    // Make textbox fully editable for statistics mode
    userInput.readOnly = false;
    userInput.style.backgroundColor = '';
    userInput.style.cursor = 'text';
    
    // Show quick questions
    document.getElementById('quickQuestionsSection').style.display = 'block';
    
  } else {
    document.getElementById('dataRadio').checked = true;
    document.getElementById('userInput').placeholder = 'Start typing to search questions...';
    
    // ✅ FIX 2 CORRECTED: Keep textbox editable so dropdown works!
    // User can type to search, but we'll guide them with placeholder
    userInput.readOnly = false;
    userInput.style.backgroundColor = '';
    userInput.style.cursor = 'text';
    
    // Hide quick questions
    document.getElementById('quickQuestionsSection').style.display = 'none';
    
    // Load master file data if not loaded
    if (masterFileData.length === 0) {
      loadMasterFileData();
    }
  }
  
  console.log('   Loading categories...');
  loadCategories();
  
  console.log('   Building questions list...');
  buildAllQuestionsList();
  
  // Show question section - with safety check
  console.log('   Showing question section...');
  console.log('   questionSection exists?', !!questionSection);
  
  if (questionSection) {
    questionSection.style.display = 'block';
    console.log('   ✅ Question section displayed!');
  } else {
    console.error('   ❌ questionSection not found!');
    initDOMElements();
    if (questionSection) {
      questionSection.style.display = 'block';
      console.log('   ✅ Question section displayed after re-init!');
    } else {
      console.error('   ❌ Still cannot find questionSection');
    }
  }
  
  console.log('🔘 selectQueryType completed');
}

function loadCategories() {
  if (!categorySelect || !questionSelect) {
    console.error('loadCategories: DOM elements not initialized!');
    initDOMElements();
    if (!categorySelect || !questionSelect) {
      console.error('loadCategories: Still unable to find DOM elements');
      return;
    }
  }
  
  categorySelect.innerHTML = '<option value="" selected disabled>Select Topic</option>';
  questionSelect.innerHTML = '<option value="" selected disabled>Select Question</option>';
  questionSelect.disabled = true;
  
  // For statistics mode, use predefined questions
  // For data mode, we'll use Google Sheets data (masterFileData) instead
  if (selectedQueryType === 'statistics') {
    currentQuestions = selectedLanguage === 'Hindi' ? statsQuestionsHindi : statsQuestions;
    
    Object.keys(currentQuestions).forEach(category => {
      const option = document.createElement('option');
      option.value = category;
      option.textContent = formatCategoryName(category);
      
      // Add special color classes to specific categories
      if (category.includes('Cultural') || category.includes('सांस्कृतिक')) {
        option.classList.add('category-cultural');
      } else if (category.includes('Religious') || category.includes('धार्मिक')) {
        option.classList.add('category-religious');
      } else if (category.includes('Date') || category.includes('तारीख')) {
        option.classList.add('category-date');
      }
      
      categorySelect.appendChild(option);
    });
  } else {
    // Data mode - categories will be populated from Google Sheets
    // For now, just set a placeholder
    currentQuestions = {};
    console.log('Data mode: Categories will be loaded from Google Sheets');
  }
}
function buildAllQuestionsList() {
  allQuestions = [];
  
  // For statistics mode, use predefined questions
  // For data mode, we'll use Google Sheets data (masterFileData) instead
  if (selectedQueryType === 'statistics') {
    currentQuestions = selectedLanguage === 'Hindi' ? statsQuestionsHindi : statsQuestions;
    
    Object.keys(currentQuestions).forEach(mainCategory => {
      const subcategories = currentQuestions[mainCategory];
      
      // Loop through subcategories
      Object.keys(subcategories).forEach(subcategory => {
        subcategories[subcategory].forEach(question => {
          allQuestions.push({
            question: question,
            category: formatCategoryName(mainCategory),
            subcategory: subcategory
          });
        });
      });
    });
  } else {
    // Data mode - questions will come from masterFileData (Google Sheets)
    currentQuestions = {};
    console.log('Data mode: Questions will be loaded from Google Sheets');
  }
}

function formatCategoryName(category) {
  // Just remove underscores and return as-is to preserve original capitalization
  // including parentheses content like (Dharamshalas)
  return category.replace(/_/g, ' ');
}

// AUTOCOMPLETE FUNCTIONALITY
function highlightMatch(text, query) {
  const regex = new RegExp(`(${query})`, 'gi');
  return text.replace(regex, '<mark>$1</mark>');
}

function filterQuestions(query) {
  if (!query || query.length < 1) {
    return [];
  }
  
  query = query.toLowerCase().trim();
  const keywords = query.split(/\s+/);
  
  return allQuestions.filter(item => {
    const questionLower = item.question.toLowerCase();
    
    // Better matching for 3-4 character searches
    if (query.length >= 3 && query.length <= 4) {
      const wordBoundaryMatch = new RegExp(`\\b${query}`, 'i').test(questionLower);
      const consecutiveMatch = questionLower.includes(query);
      return wordBoundaryMatch || consecutiveMatch;
    }
    
    return keywords.some(keyword => questionLower.includes(keyword));
  }); // Show ALL matching suggestions (no limit)
}

function initUserInputListener() {
  if (!userInput) initDOMElements();
  
  userInput.addEventListener('input', function() {
    const query = this.value.trim();
    
    if (query.length < 2) {
      autocompleteDropdown.style.display = 'none';
      return;
    }
    
    // Check which mode we're in
    if (selectedQueryType === 'data') {
      // DATA MODE - Search in masterFileData (Google Sheets)
      performFileSearch(query);
    } else {
      // STATISTICS MODE - Search in hardcoded questions
      const matches = filterQuestions(query);
  
  if (matches.length === 0) {
    autocompleteDropdown.innerHTML = '<div class="autocomplete-no-results">No matching questions found. Try different keywords.</div>';
    autocompleteDropdown.style.display = 'block';
    return;
  }
  
  let html = '';
  let lastCategory = '';
  let originalQuestion = '';
  
  matches.forEach(item => {
    if (item.category !== lastCategory) {
      html += `<div class="autocomplete-category">${item.category}</div>`;
      lastCategory = item.category;
    }
    
    const highlightedQuestion = highlightMatch(item.question, query);
    html += `<div class="autocomplete-item" data-question="${item.question}">${highlightedQuestion}</div>`;
  });
  
  autocompleteDropdown.innerHTML = html;
  autocompleteDropdown.style.display = 'block';
  
  // Add click handlers
  document.querySelectorAll('.autocomplete-item').forEach(item => {
    item.addEventListener('click', function() {
      userInput.value = this.getAttribute('data-question');
      autocompleteDropdown.style.display = 'none';
    });
  });
    } // End of statistics mode
  }); // End of input event listener

  // Close dropdown on ESC key
  userInput.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      autocompleteDropdown.style.display = 'none';
    }
  });
  
  console.log('✅ User input autocomplete initialized');
}

// Initialize dropdown event listeners (must run after DOM is ready)
function initDropdownListeners() {
  if (!categorySelect || !questionSelect) initDOMElements();
  
  categorySelect.addEventListener('change', function() {
    questionSelect.innerHTML = '<option value="" selected disabled>Select Question</option>';
    questionSelect.disabled = false;
    
    const selectedCategory = this.value;
    const categoryData = currentQuestions[selectedCategory];
    
    if (categoryData) {
      // categoryData is now an object with subcategories
      Object.keys(categoryData).forEach(subcategory => {
        // Add optgroup for subcategory
        const optgroup = document.createElement('optgroup');
        optgroup.label = subcategory;
        
        // Add questions under this subcategory
        categoryData[subcategory].forEach(question => {
          const option = document.createElement('option');
          option.value = question;
          option.textContent = question;
          optgroup.appendChild(option);
        });
        
        questionSelect.appendChild(optgroup);
      });
    }
  });

  questionSelect.addEventListener('change', function() {
    userInput.value = this.value;
    autocompleteDropdown.style.display = 'none';
  });
}

// Initialize language buttons and TTS (must run after DOM ready)
function initLanguageAndTTS() {
  document.querySelectorAll('.langBtn').forEach(btn => {
    btn.addEventListener('click', function() {
      selectedLanguage = this.getAttribute('data-lang');
      document.querySelectorAll('.langBtn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      loadCategories();
      buildAllQuestionsList();
    });
  });

  const ttsBtn = document.getElementById('ttsToggle');
  const ttsLabel = document.getElementById('ttsLabel');

  ttsBtn.addEventListener('click', () => {
    if (isSpeaking) {
      manualStop = true;
      speechSynthesis.cancel();
      isSpeaking = false;
      ttsBtn.classList.remove('speaking');
      ttsLabel.textContent = 'Listen';
      return;
    }
    
    manualStop = false;
    const answerText = document.getElementById('modalAnswer').textContent;
    
    if (!answerText || answerText === 'Thinking...') {
      alert('No answer to read yet!');
      return;
    }
    
    if (!('speechSynthesis' in window)) {
      alert('Text-to-speech is not supported in your browser.');
      return;
    }
    
    ttsUtterance = new SpeechSynthesisUtterance(answerText);
    ttsUtterance.rate = 0.9;
    ttsUtterance.pitch = 1;
    ttsUtterance.volume = 1;
  
// ========================================================================
  // SMART TTS WITH LANGUAGE DETECTION - Lines 1760-1824 Replacement
  // ========================================================================
  
  const voices = speechSynthesis.getVoices();
  
  // ========================================================================
  // DETECT LANGUAGE (Hindi vs English)
  // ========================================================================
  function detectLanguage(text) {
    const cleanText = text.replace(/[।॥.,!?;:\-\_\n\r]/g, ' ').trim();
    const hindiCharCount = (cleanText.match(/[\u0900-\u097F]/g) || []).length;
    const englishCharCount = (cleanText.match(/[a-zA-Z]/g) || []).length;
    const totalChars = hindiCharCount + englishCharCount;
    
    if (totalChars === 0) return 'en';
    const hindiPercentage = (hindiCharCount / totalChars) * 100;
    
    return hindiPercentage > 30 ? 'hi' : 'en';
  }
  
  const detectedLang = detectLanguage(answerText);
  console.log('🔍 Detected Language:', detectedLang);
  
  // ========================================================================
  // VERSION 24 STYLE - Auto-working TTS (No voice installation needed!)
  // ========================================================================
  
  // Set language HINT - let browser choose best voice automatically
  if (detectedLang === 'hi') {
    ttsUtterance.lang = 'hi-IN';  // Hint: This is Hindi text
    console.log('📢 Language hint: Hindi');
  } else {
    ttsUtterance.lang = 'en-US';  // Hint: This is English text
    console.log('📢 Language hint: English');
  }
  
  // OPTIONAL: Try to use better voice if available, but DON'T FORCE
  // (voices already declared above at line 1797)
  console.log('📊 Available voices:', voices.length);
  
  if (voices.length > 0 && detectedLang === 'hi') {
    // Try to find Hindi voice (optional enhancement)
    const hindiVoice = voices.find(voice => 
      voice.lang === 'hi-IN' || 
      (voice.lang && voice.lang.startsWith('hi'))
    );
    
    if (hindiVoice) {
      ttsUtterance.voice = hindiVoice;
      console.log('✅ Using installed Hindi voice:', hindiVoice.name);
    } else {
      // NO HINDI VOICE - Don't force English voice!
      // Leave voice undefined → browser uses multilingual system default
      console.log('ℹ️ No Hindi voice found - using system default (multilingual TTS)');
      console.log('   System will read Hindi reasonably using phonetic rules');
    }
  } else if (voices.length > 0 && detectedLang === 'en') {
    // For English, try to find best English voice
    const englishVoice = voices.find(v => 
      v.lang === 'en-US' || v.lang === 'en-GB' || v.lang === 'en-IN'
    ) || voices.find(v => v.lang && v.lang.startsWith('en'));
    
    if (englishVoice) {
      ttsUtterance.voice = englishVoice;
      console.log('✅ Using English voice:', englishVoice.name);
    }
  }
  
  console.log('🎤 Final TTS settings:');
  console.log('   Voice:', ttsUtterance.voice?.name || 'System Default (Multilingual)');
  console.log('   Language:', ttsUtterance.lang);
  console.log('   Text length:', answerText.length, 'characters');
  
  // ========================================================================
  // KEY: If no specific voice set, browser uses system default
  // System default is multilingual - can read Hindi without voice pack!
  // ========================================================================
  
  // Event handlers
  ttsUtterance.onstart = () => {
    isSpeaking = true;
    ttsBtn.classList.add('speaking');
    ttsLabel.textContent = 'Stop';
  };
  
  ttsUtterance.onend = () => {
    if (!manualStop) {
      isSpeaking = false;
      ttsBtn.classList.remove('speaking');
      ttsLabel.textContent = 'Listen';
    }
  };
  
  ttsUtterance.onerror = (e) => {
    if (manualStop) {
      manualStop = false;
      return;
    }
    
    isSpeaking = false;
    ttsBtn.classList.remove('speaking');
    ttsLabel.textContent = 'Listen';
    
    let errorMsg = 'Speech failed. ';
    if (e.error === 'canceled' || e.error === 'interrupted') {
      return;
    } else if (e.error === 'not-allowed') {
      errorMsg += 'Please enable speech in browser settings.';
    } else if (e.error === 'language-unavailable') {
      errorMsg += 'Voice not available on your device.';
    } else {
      errorMsg += 'Please try again.';
    }
    alert(errorMsg);
  };
  
  try {
    speechSynthesis.speak(ttsUtterance);
  } catch (error) {
    alert('Text-to-speech is not available on your device.');
  }
});
    
// Conversation history to maintain context - make it global
window.conversationHistory = [];

// COMPARISON FEATURE - Smart Contextual Year Selection
// ═══════════════════════════════════════════════════════════════════

// Global variables for comparison feature
let selectedYears = [];
let isComparisonActive = false;
let currentComparisonQuestion = '';

// Function to detect if query is suitable for comparison
function shouldOfferComparison(question, queryType) {
  // Only offer for data queries
  if (queryType !== 'data' && queryType !== 'STATISTICAL_DATA_QUERY') {
    console.log('❌ Not offering comparison - not a data query');
    return false;
  }
  
  // Keywords that suggest comparison might be useful
  const comparisonKeywords = [
    'year', 'years', 'annual', 'yearly',
    'trend', 'trends', 'trending',
    'growth', 'decline', 'change', 'changes', 'changed',
    'compare', 'comparison', 'comparative', 'versus', 'vs',
    'over time', 'historical', 'history',
    'last', 'previous', 'past', 'recent',
    'decade', 'period', 'from', 'to',
    'between', 'since', 'during'
  ];
  
  const lowerQuestion = question.toLowerCase();
  const hasKeyword = comparisonKeywords.some(keyword => lowerQuestion.includes(keyword));
  
  console.log('🔍 Checking if comparison should be offered:');
  console.log('   Query:', question);
  console.log('   Has comparison keyword:', hasKeyword);
  
  return hasKeyword;
}

// Show comparison prompt in modal (after answer)
function showComparisonPrompt() {
  console.log('📊 Showing comparison prompt...');
  
  // Check if already exists
  if (document.getElementById('comparisonPromptBox')) {
    console.log('⚠️ Comparison prompt already exists, skipping');
    return;
  }
  
  const promptHTML = `
    <div class="comparison-prompt-container" id="comparisonPromptBox">
      <div class="comparison-prompt-header">
        <div class="comparison-prompt-icon">🔍</div>
        <div class="comparison-prompt-text">
          <div class="comparison-prompt-title">
            Want to Compare Multiple Years?
            <span class="comparison-badge">✨ Advanced</span>
          </div>
          <div class="comparison-prompt-desc">
            Get a comprehensive analytical report with charts comparing data across different years
          </div>
        </div>
      </div>
      
      <div class="comparison-action-buttons">
        <button class="enable-comparison-btn" id="enableComparisonBtn">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          Yes, Enable Comparison Analysis
        </button>
        <button class="skip-comparison-btn" id="skipComparisonBtn">
          No, Thanks
        </button>
      </div>
    </div>
    
    <div class="year-selection-container" id="yearSelectionBox">
      <div class="year-selection-title">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        Select Years to Compare (minimum 2)
      </div>
      
      <div class="year-selection-actions">
        <button class="quick-select-btn" id="selectAllYearsBtn">
          Select All Years
        </button>
        <button class="quick-select-btn" id="clearAllYearsBtn">
          Clear All
        </button>
        <button class="quick-select-btn" id="selectLastFiveYearsBtn">
          Last 5 Years
        </button>
      </div>
      
      <div class="year-checkboxes" id="yearCheckboxContainer">
        <!-- Years will be populated here -->
      </div>
      
      <button class="generate-comparison-btn" id="generateComparisonBtn" onclick="generateComparison()" disabled>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
        </svg>
        <span id="generateBtnText">Select at least 2 years</span>
      </button>
      
      <div class="year-selection-hint">
        💡 Select at least 2 years to generate a comparative analysis with charts and insights
      </div>
    </div>
  `;
  
  // Insert after the answer section in modal
  const modalAnswerSection = document.querySelector('#modalAnswer');
  if (!modalAnswerSection) {
    console.error('❌ modalAnswer element not found!');
    return;
  }
  
  const answerParent = modalAnswerSection.parentElement;
  const promptDiv = document.createElement('div');
  promptDiv.innerHTML = promptHTML;
  
  // Insert after the answer section's parent
  answerParent.parentElement.insertBefore(promptDiv, answerParent.nextSibling);
  
  console.log('✅ Comparison prompt displayed');
  
  // Add event listeners to buttons
  const enableBtn = document.getElementById('enableComparisonBtn');
  const skipBtn = document.getElementById('skipComparisonBtn');
  
  if (enableBtn) {
    enableBtn.addEventListener('click', enableComparison);
  }
  if (skipBtn) {
    skipBtn.addEventListener('click', skipComparison);
  }
  
  // Populate years
  populateYearCheckboxes();
  
  // Add event listeners for year selection buttons after population
  setTimeout(() => {
    const selectAllBtn = document.getElementById('selectAllYearsBtn');
    const clearAllBtn = document.getElementById('clearAllYearsBtn');
    const lastFiveBtn = document.getElementById('selectLastFiveYearsBtn');
    
    if (selectAllBtn) selectAllBtn.addEventListener('click', selectAllYears);
    if (clearAllBtn) clearAllBtn.addEventListener('click', clearAllYears);
    if (lastFiveBtn) lastFiveBtn.addEventListener('click', selectLastFiveYears);
  }, 100);
}

// Enable comparison - show year selection
function enableComparison() {
  console.log('✅ User enabled comparison mode');
  isComparisonActive = true;
  
  // Hide prompt with animation
  const promptBox = document.getElementById('comparisonPromptBox');
  if (promptBox) {
    promptBox.style.transition = 'all 0.3s ease-out';
    promptBox.style.opacity = '0';
    promptBox.style.transform = 'translateY(-10px)';
    
    setTimeout(() => {
      promptBox.style.display = 'none';
    }, 300);
  }
  
  // Get the current response text from modalAnswer
  const modalAnswer = document.getElementById('modalAnswer');
  if (!modalAnswer) {
    console.error('❌ modalAnswer not found');
    alert('Error: Could not find response text');
    return;
  }
  
  const responseText = modalAnswer.innerHTML || modalAnswer.textContent;
  
  console.log('🔍 Searching for Cloudinary files in response...');
  
  // Parse Cloudinary files from response
  const groupedFiles = parseCloudinaryLinksFromResponse(responseText);
  
  if (Object.keys(groupedFiles).length === 0) {
    console.log('⚠️ No Cloudinary files found in response');
    alert('No report files found in the response. Please try a different query or ensure the response contains Cloudinary image links.');
    return;
  }
  
  // Show file selection interface
  showFileSelectionInterface(groupedFiles);
}

// Skip comparison
function skipComparison() {
  console.log('❌ User skipped comparison');
  
  const promptBox = document.getElementById('comparisonPromptBox');
  if (promptBox) {
    promptBox.style.transition = 'all 0.3s ease-out';
    promptBox.style.opacity = '0';
    promptBox.style.transform = 'translateY(-10px)';
    
    setTimeout(() => {
      promptBox.remove();
      console.log('✅ Comparison prompt removed');
    }, 300);
  }
}

// Populate year checkboxes (2014-2024)
function populateYearCheckboxes() {
  const container = document.getElementById('yearCheckboxContainer');
  if (!container) {
    console.error('❌ yearCheckboxContainer not found');
    return;
  }
  
  const currentYear = new Date().getFullYear();
  const startYear = 2014;
  
  container.innerHTML = '';
  
  console.log(`📅 Populating years from ${currentYear} to ${startYear}`);
  
  for (let year = currentYear; year >= startYear; year--) {
    const wrapper = document.createElement('div');
    wrapper.className = 'year-checkbox-wrapper';
    wrapper.setAttribute('data-year', year);
    
    wrapper.onclick = function() {
      const checkbox = this.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      updateYearSelection();
    };
    
    wrapper.innerHTML = `
      <input type="checkbox" id="year_${year}" value="${year}" onclick="event.stopPropagation(); updateYearSelection();">
      <label for="year_${year}">${year}</label>
    `;
    
    container.appendChild(wrapper);
  }
  
  console.log('✅ Year checkboxes populated');
}

// Update year selection and button state
function updateYearSelection() {
  selectedYears = [];
  const checkboxes = document.querySelectorAll('.year-checkboxes input[type="checkbox"]');
  
  checkboxes.forEach(checkbox => {
    const wrapper = checkbox.closest('.year-checkbox-wrapper');
    if (checkbox.checked) {
      selectedYears.push(checkbox.value);
      wrapper.classList.add('selected');
    } else {
      wrapper.classList.remove('selected');
    }
  });
  
  // Update button state
  const generateBtn = document.getElementById('generateComparisonBtn');
  const btnText = document.getElementById('generateBtnText');
  
  if (!generateBtn || !btnText) return;
  
  if (selectedYears.length >= 2) {
    generateBtn.disabled = false;
    btnText.textContent = `Generate Report for ${selectedYears.length} Years`;
  } else if (selectedYears.length === 1) {
    generateBtn.disabled = true;
    btnText.textContent = 'Select at least 1 more year';
  } else {
    generateBtn.disabled = true;
    btnText.textContent = 'Select at least 2 years';
  }
  
  console.log('📊 Selected years:', selectedYears);
}

// Quick selection functions
function selectAllYears() {
  const checkboxes = document.querySelectorAll('.year-checkboxes input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = true);
  updateYearSelection();
  console.log('✅ All years selected');
}

function clearAllYears() {
  const checkboxes = document.querySelectorAll('.year-checkboxes input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = false);
  updateYearSelection();
  console.log('✅ All years cleared');
}

function selectLastFiveYears() {
  clearAllYears();
  const checkboxes = document.querySelectorAll('.year-checkboxes input[type="checkbox"]');
  for (let i = 0; i < Math.min(5, checkboxes.length); i++) {
    checkboxes[i].checked = true;
  }
  updateYearSelection();
  console.log('✅ Last 5 years selected');
}

// Generate comparison report - NEW VERSION with Image Upload
function generateComparison() {
  if (selectedYears.length < 2) {
    alert('Please select at least 2 years for comparison');
    return;
  }
  
  console.log('📸 Generating comparison - showing image upload interface');
  console.log('   Selected years:', selectedYears);
  console.log('   Question:', currentComparisonQuestion);
  
  // Show image upload interface
  showImageUploadInterface();
}

// ═══════════════════════════════════════════════════════════════════
// IMAGE UPLOAD FUNCTIONALITY - Step 2 Phase 1
// ═══════════════════════════════════════════════════════════════════

// Global variables for image upload
let uploadedImages = [];
const MAX_IMAGES = 10;
const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
const ALLOWED_TYPES = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];

// Show image upload interface
function showImageUploadInterface() {
  console.log('📸 Showing image upload interface');
  
  // Hide year selection
  const yearSelection = document.getElementById('yearSelectionBox');
  if (yearSelection) {
    yearSelection.style.display = 'none';
  }
  
  // Check if upload container already exists
  let uploadContainer = document.getElementById('imageUploadContainer');
  
  if (!uploadContainer) {
    // Create upload interface HTML
    const uploadHTML = `
      <div class="image-upload-container visible" id="imageUploadContainer">
        <div class="image-upload-title">
          <svg style="width: 24px; height: 24px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
          Upload Report Images
        </div>
        
        <div class="selected-years-display">
          <strong>Selected Years:</strong> <span id="displaySelectedYears">${selectedYears.join(', ')}</span>
        </div>
        
        <div class="upload-dropzone" id="uploadDropzone" onclick="document.getElementById('imageFileInput').click()">
          <div class="upload-icon">📁</div>
          <div class="upload-text">Click to Upload Images</div>
          <div class="upload-subtext">or Drag & Drop Here</div>
          <div class="upload-specs">Supported: JPG, PNG, PDF | Max 10 images, 5MB each</div>
        </div>
        
        <input type="file" id="imageFileInput" accept="image/jpeg,image/jpg,image/png,application/pdf" 
               multiple onchange="handleFileSelect(event)">
        
        <div class="uploaded-images-section" id="uploadedImagesSection">
          <div class="uploaded-images-header">
            Uploaded Images (<span id="imageCount">0</span>):
          </div>
          <div class="images-grid" id="imagesGrid"></div>
          
          <div class="upload-actions">
            <button class="upload-action-btn upload-more-btn" onclick="document.getElementById('imageFileInput').click()">
              <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
              </svg>
              Upload More
            </button>
            <button class="upload-action-btn clear-all-btn" id="clearAllImagesBtn">
              <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
              Clear All
            </button>
            <button class="upload-action-btn process-images-btn" id="processImagesBtn" 
                    id="processImagesBtnClick" disabled>
              <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span id="processButtonText">Process Images (0)</span>
            </button>
          </div>
          
          <div class="upload-hint">
            💡 Upload statistical report pages for the years you selected. The AI will extract and compare data automatically.
          </div>
        </div>
      </div>
    `;
    
    // Insert after year selection
    const yearSelectionParent = yearSelection.parentElement;
    const uploadDiv = document.createElement('div');
    uploadDiv.innerHTML = uploadHTML;
    yearSelectionParent.appendChild(uploadDiv);
    
    // Initialize drag & drop
    initializeDragAndDrop();
    
    // Add event listeners for upload buttons
    setTimeout(() => {
      const clearAllBtn = document.getElementById('clearAllImagesBtn');
      const processBtn = document.getElementById('processImagesBtnClick');
      
      if (clearAllBtn) {
        clearAllBtn.addEventListener('click', clearAllImages);
      }
      if (processBtn) {
        processBtn.addEventListener('click', processImagesAndGenerate);
      }
    }, 100);
  } else {
    uploadContainer.classList.add('visible');
  }
  
  console.log('✅ Image upload interface displayed');
}

// Initialize drag and drop
function initializeDragAndDrop() {
  const dropzone = document.getElementById('uploadDropzone');
  
  if (!dropzone) return;
  
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropzone.addEventListener(eventName, preventDefaults, false);
  });
  
  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }
  
  ['dragenter', 'dragover'].forEach(eventName => {
    dropzone.addEventListener(eventName, () => {
      dropzone.classList.add('dragover');
    }, false);
  });
  
  ['dragleave', 'drop'].forEach(eventName => {
    dropzone.addEventListener(eventName, () => {
      dropzone.classList.remove('dragover');
    }, false);
  });
  
  dropzone.addEventListener('drop', handleDrop, false);
  
  console.log('✅ Drag and drop initialized');
}

// Handle drag and drop
function handleDrop(e) {
  const dt = e.dataTransfer;
  const files = dt.files;
  handleFiles(files);
}

// Handle file selection
function handleFileSelect(event) {
  const files = event.target.files;
  handleFiles(files);
}

// Handle files
function handleFiles(files) {
  console.log(`📁 Processing ${files.length} file(s)`);
  
  const validFiles = [];
  const errors = [];
  
  // Check total count
  if (uploadedImages.length + files.length > MAX_IMAGES) {
    alert(`⚠️ Maximum ${MAX_IMAGES} images allowed. You have ${uploadedImages.length} images. Can only add ${MAX_IMAGES - uploadedImages.length} more.`);
    return;
  }
  
  // Validate each file
  for (let file of files) {
    // Check file type
    if (!ALLOWED_TYPES.includes(file.type)) {
      errors.push(`${file.name}: Invalid file type. Only JPG, PNG, PDF allowed.`);
      continue;
    }
    
    // Check file size
    if (file.size > MAX_FILE_SIZE) {
      errors.push(`${file.name}: File too large. Max 5MB allowed.`);
      continue;
    }
    
    validFiles.push(file);
  }
  
  // Show errors if any
  if (errors.length > 0) {
    alert('⚠️ Some files were rejected:\n\n' + errors.join('\n'));
  }
  
  // Add valid files
  validFiles.forEach(file => addImageToList(file));
  
  // Update UI
  updateImagesList();
}

// Add image to list
function addImageToList(file) {
  const reader = new FileReader();
  
  reader.onload = function(e) {
    const imageData = {
      file: file,
      name: file.name,
      size: file.size,
      type: file.type,
      dataUrl: e.target.result,
      id: Date.now() + Math.random()
    };
    
    uploadedImages.push(imageData);
    updateImagesList();
    
    console.log(`✅ Added image: ${file.name} (${formatFileSize(file.size)})`);
  };
  
  reader.readAsDataURL(file);
}

// Update images list display
function updateImagesList() {
  const imagesSection = document.getElementById('uploadedImagesSection');
  const imagesGrid = document.getElementById('imagesGrid');
  const imageCount = document.getElementById('imageCount');
  const processBtn = document.getElementById('processImagesBtn');
  const processBtnText = document.getElementById('processButtonText');
  
  if (!imagesSection || !imagesGrid) return;
  
  // Update count
  if (imageCount) {
    imageCount.textContent = uploadedImages.length;
  }
  
  // Show/hide section
  if (uploadedImages.length > 0) {
    imagesSection.classList.add('visible');
  } else {
    imagesSection.classList.remove('visible');
  }
  
  // Clear grid
  imagesGrid.innerHTML = '';
  
  // Add image cards
  uploadedImages.forEach((img, index) => {
    const card = document.createElement('div');
    card.className = 'image-preview-card';
    card.innerHTML = `
      ${img.type === 'application/pdf' ? 
        `<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #fef3c7;">
          <svg style="width: 60px; height: 60px; color: #eab308;" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
          </svg>
        </div>` 
        : 
        `<img src="${img.dataUrl}" alt="${img.name}">`
      }
      <div class="image-preview-overlay">
        <div>
          <div class="image-number">Image ${index + 1}</div>
          <div class="image-size">${formatFileSize(img.size)}</div>
        </div>
      </div>
      <button class="remove-image-btn" data-index="${index}" title="Remove">
        ×
      </button>
    `;
    
    // Add event listener to remove button
    const removeBtn = card.querySelector('.remove-image-btn');
    if (removeBtn) {
      removeBtn.addEventListener('click', function() {
        const idx = parseInt(this.getAttribute('data-index'));
        removeImage(idx);
      });
    }
    
    imagesGrid.appendChild(card);
  });
  
  // Update process button
  if (processBtn && processBtnText) {
    if (uploadedImages.length > 0) {
      processBtn.disabled = false;
      processBtnText.textContent = `Process Images (${uploadedImages.length})`;
    } else {
      processBtn.disabled = true;
      processBtnText.textContent = 'Process Images (0)';
    }
  }
  
  console.log(`📊 Updated images list: ${uploadedImages.length} images`);
}

// Remove image
function removeImage(index) {
  console.log(`🗑️ Removing image ${index + 1}`);
  uploadedImages.splice(index, 1);
  updateImagesList();
}

// Clear all images
function clearAllImages() {
  if (uploadedImages.length === 0) return;
  
  if (confirm(`Are you sure you want to remove all ${uploadedImages.length} images?`)) {
    uploadedImages = [];
    updateImagesList();
    console.log('✅ All images cleared');
  }
}

// Format file size
function formatFileSize(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Process images and generate report (Step 2 Phase 2 placeholder)
function processImagesAndGenerate() {
  if (uploadedImages.length === 0) {
    alert('Please upload at least one image');
    return;
  }
  
  console.log('🚀 Processing images and generating report...');
  console.log(`   Years: ${selectedYears.join(', ')}`);
  console.log(`   Images: ${uploadedImages.length}`);
  console.log(`   Question: ${currentComparisonQuestion}`);
  
  // Show processing overlay
  showProcessingOverlay();
  
  // TODO: Phase 2 - Send to n8n workflow
  // For now, simulate processing
  setTimeout(() => {
    hideProcessingOverlay();
    
    alert(`✅ PHASE 1 COMPLETE!\n\n` +
          `Years Selected: ${selectedYears.join(', ')}\n` +
          `Images Uploaded: ${uploadedImages.length}\n` +
          `Question: ${currentComparisonQuestion}\n\n` +
          `Next Phase (Phase 2):\n` +
          `• Send images to n8n workflow\n` +
          `• AI vision extracts data from images\n` +
          `• Generate analytical comparison report\n` +
          `• Display charts and insights`);
  }, 3000);
}

// Show processing overlay
function showProcessingOverlay() {
  let overlay = document.getElementById('processingOverlay');
  
  if (!overlay) {
    const overlayHTML = `
      <div class="processing-overlay" id="processingOverlay">
        <div class="processing-content">
          <div class="processing-spinner"></div>
          <div class="processing-title">Processing Images...</div>
          <div class="processing-text">Extracting data from images</div>
          <div class="processing-text">Analyzing statistical information</div>
          <div class="processing-progress" id="processingProgress">Step 1 of 3</div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', overlayHTML);
    overlay = document.getElementById('processingOverlay');
  }
  
  overlay.classList.add('visible');
}

// Hide processing overlay
function hideProcessingOverlay() {
  const overlay = document.getElementById('processingOverlay');
  if (overlay) {
    overlay.classList.remove('visible');
  }
}

console.log('✅ Image upload functionality loaded');
// ═══════════════════════════════════════════════════════════════════
// PHASE 2A REVISED: CHECKBOX FILE SELECTION FROM SEARCH RESULTS
// ═══════════════════════════════════════════════════════════════════

// Global variable to store parsed files from response
let parsedCloudinaryFiles = [];

// Parse Cloudinary URLs from response text
function parseCloudinaryLinksFromResponse(responseText) {
  console.log('🔍 Parsing Cloudinary links from response...');
  
  // First, try to find year headers in the response (like "**1967-68**" or "1967-68" before file links)
  const yearHeaderRegex = /\*{0,2}(\d{4}-\d{2}|\d{2}-\d{2})\*{0,2}\s*\(\d+\s+files?\)/gi;
  
  // Find all Cloudinary URLs
  const cloudinaryRegex = /https:\/\/res\.cloudinary\.com\/[^\/]+\/image\/upload\/([^"\s<>]+\.(?:jpg|jpeg|png|pdf))/gi;
  
  const matches = [];
  
  // Try to match years from context in response
  const lines = responseText.split(/\n|<br>/);
  let currentYear = 'Unknown';
  
  for (const line of lines) {
    // Check if this line contains a year header
    const yearHeaderMatch = line.match(/\*{0,2}(\d{4}-\d{2}|\d{2}-\d{2})\*{0,2}\s*\(\d+\s+files?\)/i);
    if (yearHeaderMatch) {
      currentYear = yearHeaderMatch[1];
      // Normalize year format (if "67-68" convert to "1967-68")
      if (currentYear.length === 5 && currentYear.includes('-')) {
        const parts = currentYear.split('-');
        if (parts[0].length === 2) {
          currentYear = '19' + parts[0] + '-' + parts[1];
        }
      }
      console.log('📅 Found year header:', currentYear);
    }
    
    // Check if this line contains Cloudinary URLs
    let urlMatch;
    const lineRegex = /https:\/\/res\.cloudinary\.com\/[^\/]+\/image\/upload\/([^"\s<>]+\.(?:jpg|jpeg|png|pdf))/gi;
    while ((urlMatch = lineRegex.exec(line)) !== null) {
      const fullUrl = urlMatch[0];
      const path = urlMatch[1];
      
      // Try to extract year from URL path first
      const urlYearMatch = path.match(/(\d{4}-\d{2})/);
      const year = urlYearMatch ? urlYearMatch[1] : currentYear;
      
      // Extract filename
      const filename = path.split('/').pop();
      
      matches.push({
        url: fullUrl,
        year: year,
        filename: filename,
        path: path
      });
      
      console.log(`  📄 ${filename} → Year: ${year}`);
    }
  }
  
  // Fallback: if no context-based year found, try to parse entire response
  if (matches.length === 0) {
    console.log('⚠️ No files found with context, trying global search...');
    let match;
    while ((match = cloudinaryRegex.exec(responseText)) !== null) {
      const fullUrl = match[0];
      const path = match[1];
      
      // Extract year pattern from URL
      const yearMatch = path.match(/(\d{4}-\d{2})/);
      const year = yearMatch ? yearMatch[1] : 'Unknown';
      
      // Extract filename
      const filename = path.split('/').pop();
      
      matches.push({
        url: fullUrl,
        year: year,
        filename: filename,
        path: path
      });
    }
  }
  
  // Group by year
  const groupedByYear = {};
  matches.forEach(file => {
    if (!groupedByYear[file.year]) {
      groupedByYear[file.year] = [];
    }
    groupedByYear[file.year].push(file);
  });
  
  console.log(`✅ Found ${matches.length} files across ${Object.keys(groupedByYear).length} years`);
  console.log('📊 Files by year:', groupedByYear);
  
  return groupedByYear;
}

// Show file selection interface with checkboxes
function showFileSelectionInterface(groupedFiles) {
  console.log('📋 Showing file selection interface');
  
  if (Object.keys(groupedFiles).length === 0) {
    alert('No Cloudinary files found in the response. Please try a different query.');
    return;
  }
  
  // Sort years in descending order
  const sortedYears = Object.keys(groupedFiles).sort((a, b) => {
    if (a === 'Unknown') return 1;
    if (b === 'Unknown') return -1;
    return b.localeCompare(a);
  });
  
  const fileListHTML = sortedYears.map(year => {
    const files = groupedFiles[year];
    const yearId = year.replace('-', '_');
    
    return `
      <div class="year-group">
        <div class="year-header">
          <input type="checkbox" 
                 id="year_${yearId}_all" 
                 class="year-checkbox"
                 onchange="toggleYearFiles('${yearId}', this.checked)">
          <label for="year_${yearId}_all" class="year-label">
            📅 <strong>${year}</strong> - ${files.length} page${files.length > 1 ? 's' : ''} (Click to select all)
          </label>
        </div>
        
        <div class="files-list" id="files_${yearId}">
          ${files.map((file, index) => `
            <div class="file-item">
              <input type="checkbox" 
                     id="file_${yearId}_${index}" 
                     class="file-checkbox year-${yearId}"
                     data-year="${year}"
                     data-url="${file.url}"
                     data-filename="${file.filename}"
                     style="display: none;">
              <div class="file-info">
                <span class="file-icon">📄</span>
                <span class="file-name">${file.filename}</span>
              </div>
              <button class="preview-btn" onclick="window.open('${file.url}', '_blank')" title="Preview">
                👁️
              </button>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }).join('');
  
  const selectionHTML = `
    <div class="file-selection-container" id="fileSelectionContainer">
      <div class="selection-header">
        <h3 class="selection-title">
          📸 Select Years to Compare
        </h3>
        <div class="selection-subtitle">
          ✨ Select years by checking the year boxes - all report pages from that year will be analyzed automatically
        </div>
      </div>
      
      <div class="selection-stats" id="selectionStats">
        <span class="stat-item">
          <strong id="selectedCount">0</strong> files selected
        </span>
        <span class="stat-item">
          <strong id="yearsCount">0</strong> years covered
        </span>
      </div>
      
      <div class="files-container">
        ${fileListHTML}
      </div>
      
      <div class="selection-actions">
        <button class="action-btn secondary-btn" onclick="cancelFileSelection()">
          Cancel
        </button>
        <button class="action-btn secondary-btn" onclick="selectAllYears()">
          Select All Years
        </button>
      </div>
      
      <div class="dual-action-container" id="dualActionContainer" style="display: none;">
        <div class="action-method-header">
          Choose how to analyze:
        </div>
        
        <div class="action-methods">
          <button class="method-btn groq-method-btn" id="groqAnalyzeBtn" onclick="analyzeWithGroq()">
            <div class="method-icon">🚀</div>
            <div class="method-title">Analyze with Groq AI</div>
            <div class="method-description">
              ✅ Beautiful reports<br>
              ✅ Graphs & insights<br>
              ✅ Professional output<br>
              ✅ Instant results
            </div>
            <div class="method-badge recommended">RECOMMENDED</div>
          </button>
          
          <button class="method-btn copypaste-method-btn" id="copyPasteBtn" onclick="showCopyPasteOption()">
            <div class="method-icon">📋</div>
            <div class="method-title">Copy for ChatGPT</div>
            <div class="method-description">
              ✅ Manual analysis<br>
              ✅ Ask follow-ups<br>
              ✅ Use your AI<br>
              ✅ More control
            </div>
            <div class="method-badge alternative">ALTERNATIVE</div>
          </button>
        </div>
      </div>
      
      <div class="selection-hint">
        💡 Check year boxes to select all files from that year. Multiple files per year will be analyzed together.
      </div>
    </div>
  `;
  
  // Hide any existing comparison prompts
  const existingPrompts = document.querySelectorAll('.comparison-prompt-container, .year-selection-container, .comparison-confirmation');
  existingPrompts.forEach(el => el.style.display = 'none');
  
  // Insert file selection interface
  const modalAnswer = document.getElementById('modalAnswer');
  if (modalAnswer && modalAnswer.parentElement) {
    const selectionDiv = document.createElement('div');
    selectionDiv.innerHTML = selectionHTML;
    modalAnswer.parentElement.appendChild(selectionDiv);
  }
  
  updateSelectionCount();
}

// Toggle all files in a year
function toggleYearFiles(yearId, checked) {
  const checkboxes = document.querySelectorAll(`.year-${yearId}`);
  console.log(`📋 Toggling ${checkboxes.length} files for year ${yearId} to ${checked}`);
  checkboxes.forEach(cb => {
    cb.checked = checked;
  });
  // Force update after a brief delay to ensure DOM is updated
  setTimeout(() => {
    updateSelectionCount();
  }, 10);
}

// Make it globally accessible
window.toggleYearFiles = toggleYearFiles;

// Update selection count and button state
function updateSelectionCount() {
  // Get all YEAR checkboxes that are checked
  const checkedYearBoxes = document.querySelectorAll('.year-checkbox:checked');
  const yearsCount = checkedYearBoxes.length;
  
  // Count total files from checked years
  let totalFiles = 0;
  const uniqueYears = new Set();
  
  checkedYearBoxes.forEach(yearCheckbox => {
    // Get the yearId from the checkbox ID (e.g., "year_1989_90_all" → "1989_90")
    const yearId = yearCheckbox.id.replace('year_', '').replace('_all', '');
    
    // Find all file checkboxes for this year and ensure they're checked
    const fileCheckboxes = document.querySelectorAll(`.year-${yearId}`);
    fileCheckboxes.forEach(cb => {
      cb.checked = true;
      const year = cb.getAttribute('data-year');
      if (year && year !== 'Unknown') {
        uniqueYears.add(year);
      }
    });
    
    totalFiles += fileCheckboxes.length;
  });
  
  console.log(`📊 Update count: ${yearsCount} years checked, ${totalFiles} total files`);
  console.log(`📅 Unique years:`, Array.from(uniqueYears));
  
  // Update stats
  const countElement = document.getElementById('selectedCount');
  const yearsElement = document.getElementById('yearsCount');
  const dualActionContainer = document.getElementById('dualActionContainer');
  
  if (countElement) {
    countElement.textContent = totalFiles;
    console.log(`✅ Updated count element to: ${totalFiles}`);
  }
  if (yearsElement) {
    yearsElement.textContent = yearsCount;
    console.log(`✅ Updated years element to: ${yearsCount}`);
  }
  
  // Show/hide dual action buttons
  if (dualActionContainer) {
    if (totalFiles >= 2 && yearsCount >= 2) {
      dualActionContainer.style.display = 'block';
      console.log(`✅ Dual action buttons shown`);
    } else {
      dualActionContainer.style.display = 'none';
    }
  }
}

// Make it globally accessible
window.updateSelectionCount = updateSelectionCount;

// Select all files
function selectAllFiles() {
  const checkboxes = document.querySelectorAll('.file-checkbox');
  checkboxes.forEach(cb => cb.checked = true);
  
  const yearCheckboxes = document.querySelectorAll('.year-checkbox');
  yearCheckboxes.forEach(cb => cb.checked = true);
  
  updateSelectionCount();
  console.log('✅ All files selected');
}

// Alias for selectAllFiles (same function, clearer name)
function selectAllYears() {
  selectAllFiles();
  console.log('✅ All years selected');
}

// Make functions globally accessible
window.selectAllFiles = selectAllFiles;
window.selectAllYears = selectAllYears;

// Cancel file selection
function cancelFileSelection() {
  const container = document.getElementById('fileSelectionContainer');
  if (container) {
    container.remove();
  }
  console.log('❌ File selection cancelled');
}

// Make it globally accessible
window.cancelFileSelection = cancelFileSelection;

// Compare selected files
// Show copy-paste option (renamed from compareSelectedFiles)
async function showCopyPasteOption() {
  const checkedFiles = document.querySelectorAll('.file-checkbox:checked');
  
  if (checkedFiles.length < 2) {
    alert('Please select at least 2 files to compare');
    return;
  }
  
  // Group selected files by year
  const filesByYear = {};
  const yearCheckboxes = document.querySelectorAll('.year-checkbox:checked');
  
  yearCheckboxes.forEach(yearCheckbox => {
    const yearId = yearCheckbox.id.replace('year_', '').replace('_all', '');
    const fileCheckboxes = document.querySelectorAll(`.year-${yearId}`);
    
    fileCheckboxes.forEach(cb => {
      const year = cb.getAttribute('data-year');
      const url = cb.getAttribute('data-url');
      const filename = cb.getAttribute('data-filename');
      
      if (!filesByYear[year]) {
        filesByYear[year] = [];
      }
      
      filesByYear[year].push({
        url: url,
        filename: filename
      });
    });
  });
  
  console.log('📋 Generating prompt for:', filesByYear);
  
  // Generate prompt and show copy interface
  showCopyPasteInterface(filesByYear);
}

// Generate and show copy-paste prompt interface
function showCopyPasteInterface(filesByYear) {
  const years = Object.keys(filesByYear).sort().reverse();
  const question = currentComparisonQuestion || 'Compare the statistical data across these years';
  
  // Build the prompt
  let prompt = `I need help analyzing and comparing Haryana Statistical Abstract data across multiple years.\n\n`;
  prompt += `Question: ${question}\n\n`;
  prompt += `Please analyze the following report images and provide a comprehensive comparison:\n\n`;
  
  years.forEach((year, index) => {
    const files = filesByYear[year];
    prompt += `**Year ${year}** (${files.length} page${files.length > 1 ? 's' : ''}):\n`;
    files.forEach((file, fileIndex) => {
      prompt += `${fileIndex + 1}. ${file.url}\n`;
    });
    prompt += `\n`;
  });
  
  prompt += `Please:\n`;
  prompt += `1. Extract all numerical data, statistics, and key metrics from each year\n`;
  prompt += `2. Compare the data across all ${years.length} years\n`;
  prompt += `3. Identify trends, growth rates, and significant changes\n`;
  prompt += `4. Provide insights and analysis\n`;
  prompt += `5. Present the comparison in a clear, structured format\n\n`;
  prompt += `Note: The images are pages from official Haryana Statistical Abstract reports. Please analyze them carefully and extract accurate data.`;
  
  console.log('✅ Prompt generated');
  
  // Build the interface HTML
  const interfaceHTML = `
    <div class="copy-paste-container" id="copyPasteContainer">
      <div class="copy-paste-header">
        <h3 class="copy-paste-title">
          📋 Ready to Analyze with AI
        </h3>
        <div class="copy-paste-subtitle">
          Copy the prompt below and paste it into ChatGPT or Claude along with the image links
        </div>
      </div>
      
      <div class="copy-paste-stats">
        <span class="stat-badge">
          📅 ${years.length} Year${years.length > 1 ? 's' : ''}
        </span>
        <span class="stat-badge">
          📄 ${Object.values(filesByYear).reduce((sum, files) => sum + files.length, 0)} Image${Object.values(filesByYear).reduce((sum, files) => sum + files.length, 0) > 1 ? 's' : ''}
        </span>
      </div>
      
      <div class="prompt-preview-container">
        <div class="prompt-preview-header">
          <span>📝 Prompt Preview</span>
          <button class="copy-btn-small" onclick="copyPromptToClipboard()" title="Copy prompt">
            📋 Copy
          </button>
        </div>
        <div class="prompt-preview" id="promptPreview">${prompt.replace(/\n/g, '<br>')}</div>
      </div>
      
      <div class="copy-paste-actions">
        <button class="action-btn secondary-btn" onclick="closeCopyPasteInterface()">
          ← Back
        </button>
        <button class="action-btn primary-btn" onclick="copyPromptToClipboard()">
          📋 Copy Prompt to Clipboard
        </button>
      </div>
      
      <div class="ai-links-container">
        <div class="ai-links-header">
          Then paste in your preferred AI:
        </div>
        <div class="ai-links-buttons">
          <a href="https://chatgpt.com" target="_blank" class="ai-link-btn chatgpt-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M22.282 9.821a5.985 5.985 0 0 0-.516-4.91 6.046 6.046 0 0 0-6.51-2.9A6.065 6.065 0 0 0 4.981 4.18a5.985 5.985 0 0 0-3.998 2.9 6.046 6.046 0 0 0 .743 7.097 5.98 5.98 0 0 0 .51 4.911 6.051 6.051 0 0 0 6.515 2.9A5.985 5.985 0 0 0 13.26 24a6.056 6.056 0 0 0 5.772-4.206 5.99 5.99 0 0 0 3.997-2.9 6.056 6.056 0 0 0-.747-7.073z"/>
            </svg>
            Open ChatGPT
          </a>
          <a href="https://claude.ai" target="_blank" class="ai-link-btn claude-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
            Open Claude
          </a>
          <a href="https://gemini.google.com" target="_blank" class="ai-link-btn gemini-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
            Open Gemini
          </a>
        </div>
      </div>
      
      <div class="copy-paste-instructions">
        <h4>📌 How to use:</h4>
        <ol>
          <li><strong>Copy the prompt</strong> using the button above</li>
          <li><strong>Click on your preferred AI</strong> (ChatGPT, Claude, or Gemini)</li>
          <li><strong>Paste the prompt</strong> in the chat</li>
          <li><strong>The AI will analyze</strong> the images from the URLs and provide comparison!</li>
        </ol>
        <div class="tip-box">
          💡 <strong>Tip:</strong> Claude and ChatGPT can directly access images from URLs! Just paste the prompt with the links.
        </div>
      </div>
    </div>
  `;
  
  // Hide file selection interface
  const fileSelectionContainer = document.getElementById('fileSelectionContainer');
  if (fileSelectionContainer) {
    fileSelectionContainer.style.display = 'none';
  }
  
  // Insert copy-paste interface
  const modalAnswer = document.getElementById('modalAnswer');
  if (modalAnswer && modalAnswer.parentElement) {
    const copyPasteDiv = document.createElement('div');
    copyPasteDiv.innerHTML = interfaceHTML;
    modalAnswer.parentElement.appendChild(copyPasteDiv);
  }
  
  // Store prompt globally for copying
  window.generatedPrompt = prompt;
  
  console.log('✅ Copy-paste interface displayed');
}

// Copy prompt to clipboard
function copyPromptToClipboard() {
  const prompt = window.generatedPrompt;
  
  if (!prompt) {
    alert('No prompt to copy!');
    return;
  }
  
  // Copy to clipboard
  navigator.clipboard.writeText(prompt).then(() => {
    console.log('✅ Prompt copied to clipboard');
    
    // Show success feedback
    const copyBtn = document.querySelector('.copy-paste-actions .primary-btn');
    if (copyBtn) {
      const originalText = copyBtn.innerHTML;
      copyBtn.innerHTML = '✅ Copied to Clipboard!';
      copyBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
      
      setTimeout(() => {
        copyBtn.innerHTML = originalText;
        copyBtn.style.background = '';
      }, 2000);
    }
    
    // Also show a toast notification
    showToast('📋 Prompt copied! Now paste it in your preferred AI.', 'success');
  }).catch(err => {
    console.error('❌ Failed to copy:', err);
    
    // Fallback: select text
    const promptPreview = document.getElementById('promptPreview');
    if (promptPreview) {
      const range = document.createRange();
      range.selectNode(promptPreview);
      window.getSelection().removeAllRanges();
      window.getSelection().addRange(range);
      alert('Prompt selected! Press Ctrl+C (or Cmd+C on Mac) to copy.');
    }
  });
}

// Close copy-paste interface
function closeCopyPasteInterface() {
  const container = document.getElementById('copyPasteContainer');
  if (container) {
    container.remove();
  }
  
  // Show file selection again
  const fileSelectionContainer = document.getElementById('fileSelectionContainer');
  if (fileSelectionContainer) {
    fileSelectionContainer.style.display = 'block';
  }
  
  console.log('❌ Copy-paste interface closed');
}

// Show toast notification
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: ${type === 'success' ? '#10b981' : '#3b82f6'};
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 10000;
    font-size: 14px;
    font-weight: 500;
    animation: slideIn 0.3s ease-out;
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-out';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Make functions globally accessible
window.copyPromptToClipboard = copyPromptToClipboard;
window.closeCopyPasteInterface = closeCopyPasteInterface;

// Make it globally accessible
window.showCopyPasteOption = showCopyPasteOption;

// ═══════════════════════════════════════════════════════════════════
// GROQ DIRECT API ANALYSIS
// ═══════════════════════════════════════════════════════════════════

// Groq API Configuration
const GROQ_API_KEY = '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'; // Replace with your key from console.groq.com
const GROQ_API_URL = 'https://api.groq.com/openai/v1/chat/completions';
const GROQ_MODEL = 'llama-3.2-11b-vision-preview';

// Analyze with Groq AI (direct API call)
async function analyzeWithGroq() {
  console.log('🚀 Starting Groq analysis...');
  
  // Check if API key is configured
  if (!GROQ_API_KEY || GROQ_API_KEY === 'YOUR_GROQ_API_KEY_HERE') {
    showApiKeyModal();
    return;
  }
  
  // Get selected files
  const yearCheckboxes = document.querySelectorAll('.year-checkbox:checked');
  
  if (yearCheckboxes.length < 2) {
    alert('Please select at least 2 years to compare');
    return;
  }
  
  // Group files by year
  const filesByYear = {};
  yearCheckboxes.forEach(yearCheckbox => {
    const yearId = yearCheckbox.id.replace('year_', '').replace('_all', '');
    const fileCheckboxes = document.querySelectorAll(`.year-${yearId}`);
    
    fileCheckboxes.forEach(cb => {
      const year = cb.getAttribute('data-year');
      const url = cb.getAttribute('data-url');
      const filename = cb.getAttribute('data-filename');
      
      if (!filesByYear[year]) {
        filesByYear[year] = [];
      }
      
      filesByYear[year].push({ url, filename });
    });
  });
  
  console.log('📊 Files to analyze:', filesByYear);
  
  // Show processing overlay
  showGroqProcessingOverlay();
  
  try {
    // Process each year
    const years = Object.keys(filesByYear).sort().reverse();
    const yearDataResults = [];
    
    for (let i = 0; i < years.length; i++) {
      const year = years[i];
      const files = filesByYear[year];
      
      updateGroqProgress(`Analyzing ${year}...`, i + 1, years.length);
      
      const yearData = await analyzeYearWithGroq(year, files);
      yearDataResults.push(yearData);
      
      console.log(`✅ Completed ${year}`);
    }
    
    // Generate comparison report
    updateGroqProgress('Generating comparison report...', years.length, years.length);
    const comparisonReport = generateComparisonReport(yearDataResults, years);
    
    // Hide processing, show report
    hideGroqProcessingOverlay();
    showGroqReport(comparisonReport);
    
    console.log('✅ Analysis complete!');
    
  } catch (error) {
    console.error('❌ Groq analysis error:', error);
    hideGroqProcessingOverlay();
    alert(`Analysis failed: ${error.message}\n\nPlease check:\n1. Your Groq API key is valid\n2. You have internet connection\n3. Image URLs are accessible`);
  }
}

// Analyze a single year with Groq
async function analyzeYearWithGroq(year, files) {
  const question = currentComparisonQuestion || 'Statistical data analysis';
  
  // Build image content array
  const imageContent = files.map(file => ({
    type: "image_url",
    image_url: { url: file.url }
  }));
  
  // Build Groq request
  const requestBody = {
    model: GROQ_MODEL,
    messages: [
      {
        role: "user",
        content: [
          {
            type: "text",
            text: `You are analyzing pages from the Haryana Statistical Abstract for year ${year}.

User Question: ${question}

These ${files.length} images are pages from the same report. Carefully analyze ALL pages and extract:

1. All numerical data and statistics
2. Tables with headers and values  
3. Categories and subcategories
4. Units of measurement
5. Any trends or notable figures

Combine information from ALL pages into a single comprehensive dataset.

Return ONLY a JSON object (no markdown, no extra text) with this structure:
{
  "year": "${year}",
  "categories": [
    {
      "name": "Category Name",
      "subcategories": [
        {
          "name": "Subcategory",
          "value": 1234,
          "unit": "unit"
        }
      ],
      "total": 5678
    }
  ],
  "summary": "Brief summary of key findings",
  "keyMetrics": [
    {"metric": "Metric Name", "value": 1234, "unit": "unit"}
  ]
}

IMPORTANT: Return ONLY valid JSON, nothing else.`
          },
          ...imageContent
        ]
      }
    ],
    temperature: 0.1,
    max_tokens: 4000
  };
  
  console.log(`🔄 Calling Groq API for ${year}...`);
  
  // Call Groq API
  const response = await fetch(GROQ_API_URL, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${GROQ_API_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(requestBody)
  });
  
  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`Groq API error: ${response.status} - ${errorText}`);
  }
  
  const data = await response.json();
  
  // Parse response
  let extractedData;
  try {
    let content = data.choices[0].message.content.trim();
    
    // Remove markdown code blocks if present
    content = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
    
    extractedData = JSON.parse(content);
    console.log(`✅ Successfully parsed data for ${year}`);
    
  } catch (error) {
    console.error(`❌ Error parsing JSON for ${year}:`, error);
    
    // Fallback
    extractedData = {
      year: year,
      error: 'Failed to parse extracted data',
      raw_content: data.choices[0].message.content,
      categories: []
    };
  }
  
  return extractedData;
}

// Generate comparison report
function generateComparisonReport(yearDataResults, years) {
  console.log('📊 Generating comparison report...');
  
  // Build HTML report
  let html = `
    <div class="groq-report-container">
      <div class="groq-report-header">
        <h2 class="groq-report-title">
          📊 Statistical Comparison Analysis
        </h2>
        <div class="groq-report-subtitle">
          AI-Powered Analysis by Groq Llama 3.2 Vision
        </div>
      </div>
      
      <div class="groq-years-badge">
        <span class="years-analyzed">Years Analyzed: ${years.join(' • ')}</span>
      </div>
  `;
  
  // Add each year's data
  yearDataResults.forEach((yearData, index) => {
    const year = yearData.year;
    const isEven = index % 2 === 0;
    
    html += `
      <div class="groq-year-section ${isEven ? 'year-even' : 'year-odd'}">
        <div class="year-section-header">
          <h3 class="year-title">📈 Year ${year}</h3>
        </div>
    `;
    
    if (yearData.summary) {
      html += `
        <div class="year-summary">
          <strong>Summary:</strong> ${yearData.summary}
        </div>
      `;
    }
    
    // Key metrics
    if (yearData.keyMetrics && yearData.keyMetrics.length > 0) {
      html += `
        <div class="key-metrics-grid">
      `;
      
      yearData.keyMetrics.forEach(metric => {
        html += `
          <div class="metric-card">
            <div class="metric-label">${metric.metric}</div>
            <div class="metric-value">${metric.value.toLocaleString()} ${metric.unit || ''}</div>
          </div>
        `;
      });
      
      html += `</div>`;
    }
    
    // Categories
    if (yearData.categories && yearData.categories.length > 0) {
      html += `<div class="categories-container">`;
      
      yearData.categories.forEach(category => {
        html += `
          <div class="category-block">
            <h4 class="category-name">${category.name}</h4>
        `;
        
        if (category.subcategories && category.subcategories.length > 0) {
          html += `<div class="subcategories-list">`;
          
          category.subcategories.forEach(sub => {
            html += `
              <div class="subcategory-item">
                <span class="subcategory-name">${sub.name}:</span>
                <span class="subcategory-value">${typeof sub.value === 'number' ? sub.value.toLocaleString() : sub.value} ${sub.unit || ''}</span>
              </div>
            `;
          });
          
          html += `</div>`;
        }
        
        if (category.total) {
          html += `
            <div class="category-total">
              <strong>Total:</strong> ${category.total.toLocaleString()}
            </div>
          `;
        }
        
        html += `</div>`;
      });
      
      html += `</div>`;
    }
    
    html += `</div>`;
  });
  
  // Add insights section
  html += `
    <div class="groq-insights-section">
      <h3 class="insights-title">💡 Key Insights</h3>
      <div class="insights-content">
        <ul class="insights-list">
          <li>Successfully analyzed ${years.length} years of statistical data</li>
          <li>Extracted ${yearDataResults.reduce((sum, d) => sum + (d.categories?.length || 0), 0)} total categories</li>
          <li>Data spans fiscal years: ${years[years.length - 1]} to ${years[0]}</li>
          <li>Comparison enables trend analysis and growth rate calculations</li>
        </ul>
      </div>
    </div>
    
    <div class="groq-report-footer">
      <div class="footer-timestamp">
        Generated on ${new Date().toLocaleString()}
      </div>
      <div class="footer-powered">
        Powered by <strong>Groq Llama 3.2 Vision</strong> 🚀
      </div>
    </div>
  </div>
  `;
  
  return {
    html: html,
    yearData: yearDataResults,
    years: years
  };
}

// Show Groq processing overlay
function showGroqProcessingOverlay() {
  const overlay = document.createElement('div');
  overlay.id = 'groqProcessingOverlay';
  overlay.className = 'groq-processing-overlay';
  overlay.innerHTML = `
    <div class="groq-processing-card">
      <div class="groq-processing-icon">🤖</div>
      <h3 class="groq-processing-title">Analyzing with Groq AI...</h3>
      <div class="groq-progress-text" id="groqProgressText">Preparing analysis...</div>
      <div class="groq-progress-bar">
        <div class="groq-progress-fill" id="groqProgressFill"></div>
      </div>
      <div class="groq-processing-note">
        This may take 10-30 seconds depending on the number of images
      </div>
    </div>
  `;
  
  document.body.appendChild(overlay);
}

// Update Groq progress
function updateGroqProgress(text, current, total) {
  const progressText = document.getElementById('groqProgressText');
  const progressFill = document.getElementById('groqProgressFill');
  
  if (progressText) {
    progressText.textContent = text;
  }
  
  if (progressFill) {
    const percentage = (current / total) * 100;
    progressFill.style.width = `${percentage}%`;
  }
}

// Hide Groq processing overlay
function hideGroqProcessingOverlay() {
  const overlay = document.getElementById('groqProcessingOverlay');
  if (overlay) {
    overlay.remove();
  }
}

// Show Groq report
function showGroqReport(report) {
  // Hide file selection interface
  const fileSelectionContainer = document.getElementById('fileSelectionContainer');
  if (fileSelectionContainer) {
    fileSelectionContainer.style.display = 'none';
  }
  
  // Create report container
  const reportDiv = document.createElement('div');
  reportDiv.id = 'groqReportContainer';
  reportDiv.innerHTML = `
    ${report.html}
    <div class="groq-report-actions">
      <button class="action-btn secondary-btn" onclick="closeGroqReport()">
        ← Back to Selection
      </button>
      <button class="action-btn primary-btn" onclick="exportGroqReport()">
        📥 Export Report
      </button>
    </div>
  `;
  
  // Insert into modal
  const modalAnswer = document.getElementById('modalAnswer');
  if (modalAnswer && modalAnswer.parentElement) {
    modalAnswer.parentElement.appendChild(reportDiv);
  }
  
  // Store report data
  window.currentGroqReport = report;
  
  console.log('✅ Report displayed');
}

// Close Groq report
function closeGroqReport() {
  const reportContainer = document.getElementById('groqReportContainer');
  if (reportContainer) {
    reportContainer.remove();
  }
  
  // Show file selection again
  const fileSelectionContainer = document.getElementById('fileSelectionContainer');
  if (fileSelectionContainer) {
    fileSelectionContainer.style.display = 'block';
  }
}

// Export Groq report
function exportGroqReport() {
  const report = window.currentGroqReport;
  if (!report) {
    alert('No report to export');
    return;
  }
  
  // Create full HTML document
  const fullHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Statistical Comparison Report - ${new Date().toLocaleDateString()}</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f9fafb;
    }
    ${document.querySelector('style').textContent}
  </style>
</head>
<body>
  ${report.html}
</body>
</html>
  `;
  
  // Download as HTML file
  const blob = new Blob([fullHTML], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `haryana-statistical-comparison-${new Date().toISOString().split('T')[0]}.html`;
  a.click();
  URL.revokeObjectURL(url);
  
  showToast('📥 Report exported successfully!', 'success');
}

// Show API key configuration modal
function showApiKeyModal() {
  const modal = document.createElement('div');
  modal.className = 'api-key-modal-overlay';
  modal.innerHTML = `
    <div class="api-key-modal">
      <h3 class="api-key-modal-title">🔑 Groq API Key Required</h3>
      <div class="api-key-modal-content">
        <p>To use Groq AI analysis, you need a free API key.</p>
        
        <div class="api-key-steps">
          <h4>Get your FREE key (2 minutes):</h4>
          <ol>
            <li>Visit <a href="https://console.groq.com" target="_blank">console.groq.com</a></li>
            <li>Sign up for free (no credit card needed)</li>
            <li>Go to "API Keys" section</li>
            <li>Click "Create API Key"</li>
            <li>Copy the key (starts with <code>gsk_...</code>)</li>
            <li>Paste it in your HTML file (line ~4690)</li>
          </ol>
        </div>
        
        <div class="api-key-benefits">
          <h4>Free tier includes:</h4>
          <ul>
            <li>✅ 14,400 requests per day</li>
            <li>✅ Llama 3.2 90B Vision model</li>
            <li>✅ More than enough for this app!</li>
          </ul>
        </div>
        
        <div class="api-key-note">
          <strong>Note:</strong> Once you add your API key to the HTML file, 
          Groq analysis will work instantly!
        </div>
      </div>
      <div class="api-key-modal-actions">
        <button class="action-btn secondary-btn" onclick="this.closest('.api-key-modal-overlay').remove()">
          Close
        </button>
        <a href="https://console.groq.com" target="_blank" class="action-btn primary-btn">
          Get Free API Key →
        </a>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// Make functions globally accessible
window.analyzeWithGroq = analyzeWithGroq;
window.closeGroqReport = closeGroqReport;
window.exportGroqReport = exportGroqReport;

// Send selected files to n8n
async function sendFilesToN8NForComparison(filesByYear) {
  showProcessingOverlay();
  updateProcessingStatus('Preparing comparison...', 1, 5);
  
  try {
    const payload = {
      question: currentComparisonQuestion || 'Statistical data comparison',
      filesByYear: filesByYear,
      years: Object.keys(filesByYear),
      language: selectedLanguage || 'English',
      queryType: 'FILE_COMPARISON_ANALYSIS',
      timestamp: new Date().toISOString()
    };
    
    console.log('📤 Sending to n8n:', payload);
    
    updateProcessingStatus('Sending files to AI...', 2, 5);
    
    const response = await fetch(N8N_COMPARISON_WEBHOOK, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload)
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    updateProcessingStatus('AI analyzing images...', 3, 5);
    
    const result = await response.json();
    
    console.log('✅ Received from n8n:', result);
    
    updateProcessingStatus('Generating comparison report...', 4, 5);
    
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    updateProcessingStatus('Complete!', 5, 5);
    
    setTimeout(() => {
      hideProcessingOverlay();
      displayComparisonReport(result);
    }, 500);
    
  } catch (error) {
    console.error('❌ Error:', error);
    hideProcessingOverlay();
    
    alert(`❌ Comparison Failed\n\nError: ${error.message}\n\n` +
          `Please check:\n` +
          `• n8n webhook is configured\n` +
          `• Workflow is active\n` +
          `• Internet connection is stable`);
  }
}

console.log('✅ File selection interface loaded');


console.log('✅ Comparison feature JavaScript loaded');
document.getElementById('submitBtn').addEventListener('click', async () => {
  const question = userInput.value.trim();
  
  if (!selectedQueryType) {
    alert('Please select either "Learn About Statistics" or "Find Haryana Data" first!');
    return;
  }
  
  if (!question) {
    alert('Please enter your question!');
    return;
  }

  // ✅ NEW: Save as original question if this is NOT from a related question click
  // (Related questions will have " | " separator)
  if (!question.includes(' | ')) {
    originalQuestion = question;
    console.log('📝 Saved original question:', originalQuestion);
  } else {
    console.log('🔗 This is a concatenated question (original + related)');
    // Extract the original part before " | " for future related questions
    originalQuestion = question.split(' | ')[0];
  }

  const mainContainer = document.querySelector('.container-main');
  if (mainContainer) mainContainer.style.visibility = 'hidden';

  speechSynthesis.cancel();
  isSpeaking = false;
  document.getElementById('ttsToggle').classList.remove('speaking');
  document.getElementById('ttsLabel').textContent = 'Listen';

  // Display the FULL question (concatenated if it is one)
  document.getElementById('modalQuestion').textContent = question;
  document.getElementById('modalAnswer').innerHTML = 'Thinking...';
  document.getElementById('aiModal').classList.remove('hidden');
  
  // Hide related questions section initially
  const relatedSection = document.getElementById('relatedQuestionsSection');
  if (relatedSection) {
    relatedSection.style.display = 'none';
  }
  
  // Hide autocomplete dropdown
  autocompleteDropdown.style.display = 'none';

  const deviceType = /Mobile|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) ? 'Mobile' : 
                     /Tablet|iPad/i.test(navigator.userAgent) ? 'Tablet' : 'Desktop';
  const browserMatch = navigator.userAgent.match(/(Firefox|Chrome|Safari|Edge|Opera|OPR)/i);
  const browser = browserMatch ? browserMatch[0].replace('OPR', 'Opera') : 'Unknown';

  try {
    const webhookUrl = 'https://n8n-workflow-test.duckdns.org/webhook/stat-abstract';

    // ✅ Send the FULL question (concatenated or original) to webhook
    const payload = {
      question: question,  // This will be "Original | Related" if from related question
      language: selectedLanguage,
      queryType: selectedQueryType === 'statistics' ? 'STATISTICAL_CONCEPT_QUERY' : 'STATISTICAL_DATA_QUERY',
      mobNo: 'anonymous',
      deviceType: deviceType,
      browser: browser,
      timestamp: new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }),
      userAgent: navigator.userAgent
    };
    
    // Only add conversationHistory if it has items
    if (window.conversationHistory.length > 0) {
      payload.conversationHistory = window.conversationHistory;
    }

    console.log('📤 Sending to webhook:', payload);

    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const responseText = await response.text();
    console.log('Raw webhook response:', responseText);
    
    let data;
    try {
      data = JSON.parse(responseText);
      console.log('Parsed webhook response:', data);
    } catch (jsonError) {
      console.error('JSON Parse Error:', jsonError);
      console.error('Response text was:', responseText);
      throw new Error('Invalid response format from server');
    }
    
    const aiResponse = data.answer || data.error || 'No response received.';
    const disclaimer = "<br><br>────────────────<br>⚠️ <em>Disclaimer: This is an AI-generated response for guidance purposes only. Please verify important information from official sources.</em>";
    
    const formattedAnswer = aiResponse.replace(/\n/g, '<br>');
    const fullResponse = formattedAnswer + disclaimer;
    
    document.getElementById('modalAnswer').innerHTML = fullResponse;
    
    // Add to conversation history
    window.conversationHistory.push({
      question: question,
      answer: aiResponse
    });
    
    if (window.conversationHistory.length > 5) {
      window.conversationHistory.shift();
    }
    
    console.log('Updated conversation history:', window.conversationHistory);
    
    updateHistoryBadge();
    
    // Handle related questions
    let relatedQuestions = null;
    
    if (data.relatedQuestions) {
      if (Array.isArray(data.relatedQuestions)) {
        relatedQuestions = data.relatedQuestions;
      } else if (typeof data.relatedQuestions === 'string') {
        try {
          let questionsString = data.relatedQuestions.replace(/^=/, '');
          
          try {
            relatedQuestions = JSON.parse(questionsString);
            if (!Array.isArray(relatedQuestions)) {
              relatedQuestions = questionsString.split(',').map(q => q.trim()).filter(q => q.length > 0);
            }
          } catch {
            relatedQuestions = questionsString.split(',').map(q => q.trim()).filter(q => q.length > 0);
          }
        } catch (parseError) {
          console.error('Error parsing relatedQuestions:', parseError);
          relatedQuestions = null;
        }
      }
    }
    
    console.log('Parsed relatedQuestions:', relatedQuestions);
    
    if (relatedQuestions && Array.isArray(relatedQuestions) && relatedQuestions.length > 0) {
      console.log('Displaying related questions');
      displayRelatedQuestions(relatedQuestions);
    } else {
      console.log('No valid related questions found');
      if (relatedSection) {
        relatedSection.style.display = 'none';
      }
    }
    
    // Comparison Feature - Check after answer is displayed
    setTimeout(() => {
      currentComparisonQuestion = question;
      const queryType = selectedQueryType === "statistics" ? "STATISTICAL_CONCEPT_QUERY" : "STATISTICAL_DATA_QUERY";
      if (shouldOfferComparison(question, queryType)) {
        console.log("🎯 Offering comparison for suitable query");
        showComparisonPrompt();
      } else {
        console.log("ℹ️ Not offering comparison - query not suitable");
      }
    }, 800);
    
  } catch (error) {
    console.error('Error:', error);
    let errorMessage = 'Connection failed: ';
    if (error.message.includes('Invalid response format')) {
      errorMessage += 'The server sent an invalid response. Please check the webhook configuration.';
    } else if (error.message.includes('HTTP error')) {
      errorMessage += error.message + '. The server may be down or the webhook URL is incorrect.';
    } else {
      errorMessage += error.message;
    }
    document.getElementById('modalAnswer').innerHTML = errorMessage.replace(/\n/g, '<br>');
    if (relatedSection) {
      relatedSection.style.display = 'none';
    }
  }
});

  // ✅ NEW FUNCTION: Display Related Questions
function displayRelatedQuestions(questions) {
  const section = document.getElementById('relatedQuestionsSection');
  const listContainer = document.getElementById('relatedQuestionsList');
  
  if (!questions || questions.length === 0) {
    section.style.display = 'none';
    return;
  }
  
  // Clear previous questions
  listContainer.innerHTML = '';
  
  // Add each related question as a clickable button
  questions.forEach((q, index) => {
    const questionBtn = document.createElement('button');
    questionBtn.className = 'w-full text-left p-3 bg-white hover:bg-purple-50 border-2 border-purple-200 hover:border-purple-400 rounded-xl transition-all duration-200 text-sm font-medium text-gray-700 hover:text-purple-700 flex items-start gap-2';
    questionBtn.innerHTML = `
      <span class="flex-shrink-0 w-6 h-6 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center text-xs font-bold mt-0.5">
        ${index + 1}
      </span>
      <span class="flex-1">${q}</span>
      <svg class="w-4 h-4 flex-shrink-0 mt-1 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
      </svg>
    `;
    
    // ✅ MODIFIED: Click handler with CONCATENATION
    questionBtn.addEventListener('click', () => {
      console.log('🔗 Related question clicked:', q);
      console.log('📝 Original question was:', originalQuestion);
      
      // Close current modal
      document.getElementById('aiModal').classList.add('hidden');
      const mainContainer = document.querySelector('.container-main');
      if (mainContainer) mainContainer.style.visibility = 'visible';
      
      // ✅ CONCATENATE: Original Question | Related Question
      const concatenatedQuestion = `${originalQuestion} | ${q}`;
      console.log('✅ Concatenated question:', concatenatedQuestion);
      
      // Set the concatenated question in input field
      userInput.value = concatenatedQuestion;
      
      // Auto-submit after a brief delay
      setTimeout(() => {
        document.getElementById('submitBtn').click();
      }, 300);
    });
    
    listContainer.appendChild(questionBtn);
  });
  
  section.style.display = 'block';
}
  

let recognition;
let isRecording = false;

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = 'hi-IN';

  recognition.onstart = () => {
    isRecording = true;
    const voiceBtn = document.getElementById('voiceBtn');
    voiceBtn.classList.add('recording');
    voiceBtn.title = 'Recording... Click to stop';
  };

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    userInput.value = transcript;
    // Trigger autocomplete
    userInput.dispatchEvent(new Event('input'));
  };

  recognition.onend = () => {
    isRecording = false;
    const voiceBtn = document.getElementById('voiceBtn');
    voiceBtn.classList.remove('recording');
    voiceBtn.title = 'Click to speak';
  };

  recognition.onerror = (event) => {
    isRecording = false;
    const voiceBtn = document.getElementById('voiceBtn');
    voiceBtn.classList.remove('recording');
    voiceBtn.title = 'Click to speak';
    if (event.error !== 'no-speech') {
      alert('Voice recognition failed. Please try again.');
    }
  };
}

document.getElementById('voiceBtn').addEventListener('click', (e) => {
  e.preventDefault();
  if (recognition) {
    if (isRecording) {
      recognition.stop();
    } else {
      recognition.start();
    }
  } else {
    alert('Voice recognition is not supported in your browser.');
  }
});

  // End of TTS listener
}

// Initialize music toggle (must run after DOM ready)
function initMusicToggle() {
  const fluteMusic = document.getElementById('fluteMusic');
  const musicToggle = document.getElementById('musicToggle');
  const musicLabel = document.getElementById('musicLabel');

  // ✅ CHECK IF ELEMENTS EXIST BEFORE ACCESSING
  if (!fluteMusic || !musicToggle || !musicLabel) {
    console.log('ℹ️ Music player elements not found (feature removed from UI)');
    return; // Exit safely without crashing
  }

  musicToggle.addEventListener('click', () => {
    if (fluteMusic.paused) {
      fluteMusic.play().catch(e => {
        alert("Please interact with the page first, then click to play music.");
      });
      musicLabel.textContent = "Pause Flute";
    } else {
      fluteMusic.pause();
      musicLabel.textContent = "Play Flute";
    }
  });
}

document.getElementById('closeBtn').onclick = () => {
  speechSynthesis.cancel();
  document.getElementById('aiModal').classList.add('hidden');
  const mainContainer = document.querySelector('.container-main');
  if (mainContainer) mainContainer.style.visibility = 'visible';
};

// New Topic button - clears conversation history
document.getElementById('newTopicBtn').onclick = () => {
  window.conversationHistory = [];
  updateHistoryBadge();
  alert('✨ Conversation history cleared! You can now start a new topic.');
  console.log('Conversation history cleared');
};

// Function to update history badge
function updateHistoryBadge() {
  const badge = document.getElementById('historyBadge');
  const count = document.getElementById('historyCount');
  
  if (window.conversationHistory && window.conversationHistory.length > 0) {
    badge.classList.remove('hidden');
    count.textContent = window.conversationHistory.length;
  } else {
    badge.classList.add('hidden');
  }
}

document.getElementById('closeModal').onclick = () => {
  speechSynthesis.cancel();
  document.getElementById('aiModal').classList.add('hidden');
  const mainContainer = document.querySelector('.container-main');
  if (mainContainer) mainContainer.style.visibility = 'visible';
};

document.getElementById('whatsappBtn').onclick = () => {
  const question = document.getElementById('modalQuestion').textContent;
  const answer = document.getElementById('modalAnswer').textContent;
  
  // Format message for WhatsApp
  const message = `*Haryana DataVista - Statistical Assistant*\n\n*Question:*\n${question}\n\n*Answer:*\n${answer}\n\n_Generated by Haryana DataVista Chatbot_\n🔗 https://esaharyana.gov.in`;
  
  // Open WhatsApp with pre-filled message
  const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
  window.open(whatsappUrl, '_blank');
};


function openFeedback() {
  const feedbackModal = document.getElementById('feedbackModal');
  const feedbackIframe = document.getElementById('feedbackIframe');
  const iframeLoader = document.getElementById('iframeLoader');
  
  feedbackModal.classList.add('show');
  iframeLoader.style.display = 'block';
  
  feedbackIframe.src = 'https://vksinglakkr.github.io/StatisticalAbstract/feedback_StatAbs.html';
  
  feedbackIframe.onload = function() {
    iframeLoader.style.display = 'none';
  };feedbackIframe.onerror = function() {
    iframeLoader.innerHTML = '<p style="color: #ef4444; font-weight: 600;">Failed to load feedback form</p>';
  };
}

function closeFeedback() {
  const feedbackModal = document.getElementById('feedbackModal');
  const feedbackIframe = document.getElementById('feedbackIframe');
  const iframeLoader = document.getElementById('iframeLoader');
  
  feedbackModal.classList.remove('show');
  feedbackIframe.src = '';
  
  iframeLoader.style.display = 'none';
  iframeLoader.innerHTML = '<div class="spinner"></div><p style="color: #64748b; font-weight: 600;">Loading feedback form...</p>';
}

document.getElementById('feedbackModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeFeedback();
  }
});

function openLiveTelecast() {
  window.open('https://www.youtube.com/live/My5T4LiHBdw', '_blank', 'noopener,noreferrer');
}    
function openTutorialVideos() {
/*
  const quizModal = document.getElementById('quizModal');
  const quizIframe = document.getElementById('quizIframe');
  const quizIframeLoader = document.getElementById('quizIframeLoader');
  
  quizModal.classList.add('show');
  quizIframeLoader.style.display = 'block';
  
  quizIframe.src = 'https://igmquiz.in/webloginkkr.aspx';
  
  quizIframe.onload = function() {
    quizIframeLoader.style.display = 'none';
  };
  
  quizIframe.onerror = function() {
    quizIframeLoader.innerHTML = '<p style="color: #ef4444; font-weight: 600;">Failed to load Tutorial Videos</p>';
  };
*/
window.open('https://igmquiz.in/webloginkkr.aspx', '_blank');
}

function closeQuizChatbot() {
  const quizModal = document.getElementById('quizModal');
  const quizIframe = document.getElementById('quizIframe');
  const quizIframeLoader = document.getElementById('quizIframeLoader');
  
  quizModal.classList.remove('show');
  quizIframe.src = '';
  
  quizIframeLoader.style.display = 'none';
  quizIframeLoader.innerHTML = '<div class="spinner"></div><p style="color: #64748b; font-weight: 600;">Loading Videos...</p>';
}

document.getElementById('quizModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeQuizChatbot();
  }
});
  

// ═══════════════════════════════════════════════════════════════════
// FILE SEARCH SYSTEM
// ═══════════════════════════════════════════════════════════════════

async function loadMasterFileData() {
  try {
    console.log('🔄 Loading questions from Google Sheets (TSV)...');
    console.log('   URL:', GOOGLE_SHEET_URL);
    
    const response = await fetch(GOOGLE_SHEET_URL);
    console.log('   📡 Response status:', response.status, response.statusText);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const tsvText = await response.text();
    console.log('   📄 TSV text length:', tsvText.length, 'characters');
    
    const lines = tsvText.split('\n');
    console.log('   📄 Total lines:', lines.length);
    
    masterFileData = []; // Clear existing data
    
    // Parse TSV - Skip header row (index 0)
    for (let i = 1; i < lines.length; i++) {
      const line = lines[i].trim();
      if (!line) continue;
      
      // Split by TAB (TSV format) - supports commas in questions
      const columns = line.split('\t');
      
      // Your sheet format: Chp_Code [TAB] Chapter_Name [TAB] sec_code [TAB] part_code
      // Column 0 = Chp_Code (1, 2, 3...)
      // Column 1 = Chapter_Name (the actual question)
      // Column 2 = sec_code (Admin_Stru, etc.)
      // Column 3 = part_code (SS, ES, etc.)
      if (columns.length >= 3) {
        const chp_code = columns[0].trim();   // Column 0 = Chp_Code
        const question = columns[1].trim();   // Column 1 = Chapter_Name (ACTUAL QUESTION)
        const sec_code = columns[2].trim();   // Column 2 = sec_code
        
        if (question && sec_code && chp_code) {
          masterFileData.push({
            chp_code: chp_code.padStart(2, '0'),
            chapter_name: question,
            sec_code: sec_code,
            part_code: '',
            search_text: question.toLowerCase()
          });
        }
      }
    }
    
    console.log(`✅ Loaded ${masterFileData.length} questions from Google Sheets`);
    console.log('   Sample data:', masterFileData.slice(0, 3));
    
  } catch (error) {
    console.error('❌ Error loading Google Sheets data:', error);
    console.error('   Error details:', error.message);
    
    // Fallback to empty array
    masterFileData = [];
    
    alert('⚠️ Could not load questions from Google Sheets. Please check:\n' +
          '1. Sheet is published to web (TSV format)\n' +
          '2. Sheet is publicly accessible\n' +
          '3. URL is correct');
  }
}

// File Search Input Handler - Initialize after DOM loads
let fileSearchTimeout;

function initFileSearchListener() {
  if (!userInput) initDOMElements();
  
  // We use the SAME userInput for both modes
  // The autocomplete behavior changes based on selectedQueryType
  console.log('✅ File search uses userInput field');
}

function performFileSearch(query) {
  const dropdown = document.getElementById('autocompleteDropdown'); // Use same dropdown
  
  if (!query || query.length < 2) {
    dropdown.style.display = 'none';
    return;
  }
  
  const searchTerm = query.toLowerCase();
  const results = masterFileData.filter(item => 
    item.search_text.includes(searchTerm)
  ).slice(0, 15);
  
  if (results.length > 0) {
    displayFileAutocomplete(results, dropdown);
  } else {
    dropdown.innerHTML = '<div class="autocomplete-no-results">No matching questions found in Google Sheets</div>';
    dropdown.style.display = 'block';
  }
}

// ============================================================================
// FUNCTION 2: displayFileAutocomplete (Replace around line 2170)
// ============================================================================
function displayFileAutocomplete(results, dropdown) {
  let html = '';
  
  results.forEach(item => {
    // ✅ FIX 3: Show only question text in autocomplete (no chapter/sector codes)
    html += `
      <div class="autocomplete-item" data-question="${item.chapter_name}" data-item='${JSON.stringify(item)}'>
        <div style="font-weight: 600;">${item.chapter_name}</div>
      </div>
    `;
  });
  
  dropdown.innerHTML = html;
  dropdown.style.display = 'block';
  
  // Add click handlers
  document.querySelectorAll('.autocomplete-item').forEach(element => {
    element.addEventListener('click', function() {
      const itemData = JSON.parse(this.getAttribute('data-item'));
      selectFileItem(itemData);
      userInput.value = itemData.chapter_name;
      dropdown.style.display = 'none';
    });
  });
}


function selectFileItem(item) {
  selectedFileItem = item;
  
  // Use userInput (the main input field) instead of non-existent fileSearchInput
  if (userInput) {
    userInput.value = item.chapter_name;
  }
  
  const dropdown = document.getElementById('autocompleteDropdown');
  if (dropdown) {
    dropdown.style.display = 'none';
  }
  
  const displayElement = document.getElementById('fileSelectedDisplay');
  if (displayElement) {
    displayElement.innerHTML = `
      <strong>📋 Selected:</strong> ${item.chapter_name}<br>
      <small>Section: ${item.sec_code} | Chapter: ${item.chp_code}</small>
    `;
    displayElement.style.display = 'block';
  }
  
  console.log('✅ Selected file item:', item);
}

async function searchStatFiles() {
  if (!selectedFileItem) {
    alert('⚠️ Please select a question from the dropdown first!');
    return;
  }
  
  const resultsDiv = document.getElementById('fileResultsArea');
  resultsDiv.innerHTML = '<div class="text-center py-8 text-gray-600">🔍 Searching for files...</div>';
  
  const filePrefix = selectedFileItem.sec_code + selectedFileItem.chp_code;
  console.log('🔍 Searching for files with prefix:', filePrefix);
  
  try {
    const response = await fetch(FILE_API_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        type: 'file_search',  // ⚠️ REQUIRED FOR N8N ROUTING
        filePrefix: filePrefix,
        question: selectedFileItem.chapter_name,
        sec_code: selectedFileItem.sec_code,
        chp_code: selectedFileItem.chp_code
      })
    });
    
    const data = await response.json();
    
    if (data.success && data.files && data.files.length > 0) {
      displayFileResults(data.files, selectedFileItem);
    } else {
      displayNoFileResults(selectedFileItem, filePrefix);
    }
    
  } catch (error) {
    console.error('❌ Error:', error);
    resultsDiv.innerHTML = '<div class="text-center py-8 text-red-600">❌ Error searching files. Please try again.</div>';
  }
}

function displayFileResults(files, selectedItem) {
  const resultsDiv = document.getElementById('fileResultsArea');
  
  const filesByYear = {};
  files.forEach(file => {
    if (!filesByYear[file.year]) {
      filesByYear[file.year] = [];
    }
    filesByYear[file.year].push(file);
  });
  
  const years = Object.keys(filesByYear).sort().reverse();
  
  let html = `
    <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-5 rounded-xl mb-5 border-2 border-green-200">
      <h3 class="text-lg font-bold text-gray-800 mb-2">✅ Found ${files.length} file(s)</h3>
      <p class="text-gray-700 font-semibold text-sm">${selectedItem.chapter_name}</p>
      <p class="text-xs text-gray-600 mt-1">Section: ${selectedItem.sec_code} | Chapter: ${selectedItem.chp_code}</p>
    </div>
  `;
  
  years.forEach(year => {
    html += `
      <div class="file-year-group">
        <h4>📅 Year: ${year}</h4>
    `;
    
    filesByYear[year].forEach(file => {
      const icon = file.extension === 'pdf' ? '📕' : '📊';
      html += `
        <a href="${file.url}" target="_blank" class="file-download-link">
          ${icon} ${file.filename}
        </a>
      `;
    });
    
    html += `</div>`;
  });
  
  resultsDiv.innerHTML = html;
}

function displayNoFileResults(selectedItem, filePrefix) {
  const resultsDiv = document.getElementById('fileResultsArea');
  resultsDiv.innerHTML = `
    <div class="text-center py-12 bg-yellow-50 rounded-xl border-2 border-yellow-200">
      <div class="text-6xl mb-4">📭</div>
      <h4 class="text-lg font-bold text-gray-800 mb-2">No files found</h4>
      <p class="text-gray-600 text-sm">No data files found for: <strong>${selectedItem.chapter_name}</strong></p>
      <p class="text-xs text-gray-500 mt-2">File prefix: ${filePrefix}</p>
    </div>
  `;
}

// Close file autocomplete when clicking outside
document.addEventListener('click', function(e) {
  const fileInput = document.getElementById('fileSearchInput');
  const fileDropdown = document.getElementById('autocompleteDropdown');
  
  if (fileInput && fileDropdown) {
    if (!fileInput.contains(e.target) && !fileDropdown.contains(e.target)) {
      fileDropdown.style.display = 'none';
    }
  }
});
// ═══════════════════════════════════════════════════════════════════
// Last Updated Timestamp - DYNAMIC DATE (from IGM)
// ═══════════════════════════════════════════════════════════════════
window.addEventListener('DOMContentLoaded', function() {
  console.log('🚀 Page loaded - initializing components...');
  
  // Initialize DOM elements
  initDOMElements();
  console.log('✅ DOM elements initialized');
  
  // DON'T auto-select any radio button - let user choose
  // questionSection stays hidden until user selects a radio button
  
  // Initialize autocomplete listeners
  initUserInputListener();
  console.log('✅ User input listener initialized');
  
  initFileSearchListener();
  console.log('✅ File search listener initialized');
  
  // Initialize dropdown listeners (category/question select)
  initDropdownListeners();
  console.log('✅ Dropdown listeners initialized');
  
  // Initialize language buttons and TTS
  initLanguageAndTTS();
  console.log('✅ Language and TTS initialized');
  
  // Initialize music toggle (SAFELY - checks if elements exist)
  initMusicToggle();
  console.log('✅ Music toggle check completed');
  
  // Set last modified date - IMPROVED VERSION
  const elem = document.getElementById('lastModified');
  console.log('📅 Setting last modified date...');
  console.log('   Element found:', elem ? 'YES' : 'NO');
  
  if (elem) {
    try {
      // Get the last modified string
      const lastModifiedStr = document.lastModified;
      console.log('   Raw lastModified string:', lastModifiedStr);
      
      // Parse the date
      const lastModifiedDate = new Date(lastModifiedStr);
      console.log('   Parsed date object:', lastModifiedDate);
      console.log('   Is valid date?', !isNaN(lastModifiedDate.getTime()));
      
      // Check if valid date
      if (isNaN(lastModifiedDate.getTime())) {
        // Fallback to current date
        console.warn('⚠️ Could not parse lastModified, using current date');
        const now = new Date();
        elem.textContent = now.toLocaleDateString('en-US', {
          year: 'numeric', month: 'long', day: 'numeric'
        }) + ' at ' + now.toLocaleTimeString('en-US', {
          hour: '2-digit', minute: '2-digit', hour12: true
        });
      } else {
        // Valid date - format it
        elem.textContent = lastModifiedDate.toLocaleDateString('en-US', {
          year: 'numeric', month: 'long', day: 'numeric'
        }) + ' at ' + lastModifiedDate.toLocaleTimeString('en-US', {
          hour: '2-digit', minute: '2-digit', hour12: true
        });
      }
      
      elem.style.display = 'inline';
      console.log('✅ Last Modified set to:', elem.textContent);
      
    } catch (error) {
      console.error('❌ Error setting last modified:', error);
      // Final fallback
      elem.textContent = 'Recently Updated';
      elem.style.display = 'inline';
    }
  } else {
    console.error('❌ Element with id="lastModified" not found in HTML!');
  }
  

// ═══════════════════════════════════════════════════════════════════
  console.log('🎉 All initialization complete!');
});</script>

</body>
</html>
